/* contact me: borian@vip.qq.com */console.log("请叫我柏子:borian@vip.qq.com -.-!");window.requestAFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)}}(),Array.prototype.desInsert=function(a,b){if(this.indexOf(a)>=0)return!1;if(!this.length)return this.push(a),!0;for(var c=0,d=this[0],e=0;d&&!(a[b]>=d[b]);d=this[++c])e++;return this[e+1]&&this[e][b]<this[e+1][b]?(this.push(a),this.des(b)):this.splice(e,0,a),!0},Array.prototype.ascInsert=function(a,b){if(this.indexOf(a)>=0)return!1;if(!this.length)return this.push(a),!0;for(var c=0,d=this[0],e=0;d&&!(a[b]<=d[b]);d=this[++c])e++;return this[e+1]&&this[e][b]>this[e+1][b]?(this.push(a),this.des(b)):this.splice(e,0,a),!0},Array.prototype.max=function(a){if("function"==typeof a){var b=a(this[0]);this.forEach(function(c){var d=a(c);d>c&&(b=d)})}else{var b=this[0][a];this.forEach(function(c){c[a]>b&&(b=c[a])})}return b},Array.prototype.min=function(a){if("function"==typeof a){var b=a(this[0]);this.forEach(function(c){var d=a(c);c>d&&(b=d)})}else{var b=this[0][a];this.forEach(function(c){c[a]<b&&(b=c[a])})}return b},Array.prototype.remove=function(a){var b=this.indexOf(a);return b>=0?(this.splice(b,1),!0):!1},Array.prototype.add=function(a){var b=this.indexOf(a);return 0>b?(this.push(a),!0):!1},Array.prototype.des=function(a){this.sort(function(b,c){return b[a]>c[a]?-1:1})},Array.prototype.asc=function(a){this.sort(function(b,c){return b[a]<c[a]?-1:1})},Array.prototype.findBy=function(a,b){for(var c=0,d=this[0];d;d=this[++c])if(d[a]===b)return d;return null},Array.prototype.clone=function(){for(var a=0,b=this[0],c=[];b;b=this[++a]){if(!b.clone)return null;c.push(b.clone())}return c},Array.prototype.clone=function(a){for(var b=0,c=a[0];c;c=a[++b]){if(!c.clone)return null;this.push(c.clone(c))}return this},Boolean.prototype.toFloat=function(){return this?1:0},String.prototype.format=function(){var a=arguments;return this.replace(/\{\d+?\}/g,function(b){return a[parseInt(b.substr(1,b.length-2))]||(""===a[parseInt(b.substr(1,b.length-2))]?"":b)})},Object.prototype.addProperty=function(a,b){"string"==typeof a?a={privateName:"_"+a,publicName:a}:a.privateName||(a.privateName="_"+a.publicName),a.invalid=b!==!1;var c={enumerable:!1,configurable:!0};return a.get!==!1&&(c.get="function"!=typeof a.get?new Function("return this."+a.privateName+";"):a.get),a.set!==!1&&(c.set="function"!=typeof a.set?new Function("val",'var o=this.{0};if(o!==val)this.{0}=val;this.notify("{1}",o);'.format(a.privateName,a.publicName)+(a.invalid?"this.invalid();":"")):a.set),Object.defineProperty(this,a.publicName,c),this},Object.prototype.toInt=function(){var a=parseInt(this);return isNaN(a)?void 0:a},Object.prototype.toFloat=function(){var a=parseFloat(this);return isNaN(a)?void 0:a},Object.prototype.on=function(a,b){if("string"!=typeof a||!a||"function"!=typeof b)return this;var c,d=this._callbacks;return d||(this._callbacks=d={}),c=d[a],c?c.add(b):d[a]=[b],this},Object.prototype.emit=function(a,b,c){var d,e=this._callbacks;return e&&(d=e[a])?(b instanceof Array||(b=[b]),c=c||this,e[a]=d.filter(function(a){return-1!=a.apply(c,b)}),!0):!0},Object.prototype.toBool=function(){return 1==this},Object.prototype.allOwnPros=function(a){for(var b=0,c=Object.getOwnPropertyNames(this),d=c[0];d;d=c[++b])a.apply(this,[this[d],d])},Object.defer=window.Q?Q.defer:function(){function a(a){setTimeout(a,1)}function b(){var e,f=[],g=Object.create(b.prototype);return g.resolve=function(a){if(f){e=c(a);for(var b=0,d=f.length;d>b;b++)e.then.apply(e,f[b]);f=void 0}},g.reject=function(a){g.resolve(d(a))},g.promise={then:function(c,g){var h=b();c=c||function(a){return a},g=g||function(a){return d(a)};var i=function(a){h.resolve(c(a))},j=function(a){h.resolve(g(a))};return f?f.push([i,j]):a(function(){e.then(i,j)}),h.promise}},g}function c(d){if(d instanceof c)return d;var e=Object.create(c.prototype);return e.then=function(c){var e=b();return a(function(){e.resolve(c(d))}),e.promise},e}function d(d){var e=Object.create(c.prototype);return e.then=function(c,e){var f=b();return a(function(){f.resolve(e(d))}),f.promise},e}return b}(),Math.log2=Math.log2||function(a){return Math.log(a)*Math.LOG2E},Math.isInt=function(a){var b=parseInt(a,10);return!isNaN(b)&&a==b&&a.toString()==b.toString()},Function.prototype.inherit=function(a,b,c){var d=Object.create(c?new c:{});for(var e in a)d[e]=a[e];return b.forEach(function(a){d.addProperty(a)}),this.prototype=d,this};var bgl={init:function(a){var b,c=a.getContext("webgl")||a.getContext("experimental-webgl")||WebGLRenderingContext;return b=new this.GlConfig(c),bgl.event&&(b.eventPool=bgl.event.getEventPool(a)),c.cfg=b,c},GlConfig:function(a){a.cfg=this,this.gl=a,this._program=null,this.resManager=new bgl.resource.ResourceManager(this),this.scenes=[],this.state={enable:1}},createProgram:function(a,b,c){var d,e=a.createProgram(),f=a.createShader(a.FRAGMENT_SHADER);b="string"==typeof b?b:b.innerHTML,c="string"==typeof c?c:c.innerHTML,a.shaderSource(f,c),a.compileShader(f);var g=a.getShaderParameter(f,a.COMPILE_STATUS);return g||(d=a.getShaderInfoLog(f),console.log("fshader Failed to compile shader: "+d)),a.attachShader(e,f),f=a.createShader(a.VERTEX_SHADER),a.shaderSource(f,b),a.compileShader(f),g=a.getShaderParameter(f,a.COMPILE_STATUS),g||(d=a.getShaderInfoLog(f),console.log("vshader Failed to compile shader: "+d)),a.attachShader(e,f),a.linkProgram(e),e.gl=a,e.attributes=this._getAttributeEntries(a,e,b),e.uniforms=this._getUniformEntries(a,e,b,c),e},_getUniformEntries:function(a,b,c,d){for(var e,f,g={},h=/\buniform\s+(vec[234]|float|sampler2D|samplerCube|mat[234])\s+\b(\w+)\b\s?;/gm;e=h.exec(c+d);){if(f=a.getUniformLocation(b,e[2]),-1==f)throw"get uniform failed";g[e[2]]=new bgl.foundation.UniformEntry(e[1],f,b)}return g},_getAttributeEntries:function(a,b,c){for(var d,e,f={},g=/\battribute\s+(vec[234]|float)\s+\b(\w+)\b\s?;/gm;e=g.exec(c);){if(d=a.getAttribLocation(b,e[2]),-1==d)throw"get attribute failed";f[e[2]]=new bgl.foundation.AttributeEntry(e[1],d,b)}return f}};bgl.GlConfig.prototype={get nextScene(){return this.state._nextScene},set nextScene(a){a&&a instanceof bgl.model.Scene&&a!==this.curScene&&(this.state._nextScene=a)},set curScene(a){var b=this.curScene;a instanceof bgl.model.Scene&&b!==a&&(this.state._scene=a,b&&b._timeline.stop(),a._timeline.start())},get curScene(){return this.state._scene},set curRender(a){this.state._render=a},get curRender(){return this.state._render},get curFrameBuffer(){return this.resManager._bindingFrameBuffer},set curFrameBuffer(a){a?a.bind(this.gl):this.resManager.bindingFrameBuffer=a},set curProgram(a){a&&a!==this._program&&(this.gl.useProgram(a),this.state._program=a)},get curProgram(){return this.state._program},set curGeometry(a){this.state._geometry=a},get curGeometry(){return this.state._geometry},get curCamera(){return this.curScene.camera},get width(){return this.gl.drawingBufferWidth},get height(){return this.gl.drawingBufferHeight},set width(a){if(a=parseInt(a),a||a!==this.width){var b=this.gl,c=this.curScene,d=this.height,e=this.curFrameBuffer;b.canvas.width=a,b.viewport(0,0,a,d),c&&(c.camera.aspect=a/d,c.invalid()),e&&(e.width=a)}},set height(a){if(a=parseInt(a),a||a!==this.height){var b=this.gl,c=this.curScene,d=this.width,e=this.curFrameBuffer;b.canvas.height=a,b.viewport(0,0,d,a),c&&(c.camera.aspect=d/a,c.invalid()),e&&(e.height=a)}},set enable(a){this.state.enable=!!a},get enable(){return this.state.enable},glClear:function(a,b){var c=this.gl,d=c.COLOR_BUFFER_BIT;a&&(d|=c.DEPTH_BUFFER_BIT),b&&(d|=c.STENCIL_BUFFER_BIT),c.clear(d)},update:function(a){this.curScene=this.nextScene,this.eventPool&&this.eventPool.update(a),this.emit("update",[a])},run:function(){if(this.enable){this.update(this);var a=this.curScene,b=this.gl;a&&a.render(b,this)}window.requestAnimationFrame(this.run.bind(this),b.canvas)},add:function(a){if(a instanceof bgl.model.Scene){-1==a.order&&(a.order=this.scenes.length);var b=this.scenes.ascInsert(a,"order");b&&(a.cfg=this,this.curScene||this.nextScene||(this.nextScene=a))}return this},remove:function(a,b){return this.scenes.remove(a)&&(b||a.dispose(this.cfg),a.cfg=null),this}},bgl.math={Matrix4:function(a){var b,c,d;if(a)for(d=new Float32Array(16),c=a.elements?a.elements:a,b=0;16>b;b++)d[b]=c[b];this.elements=d||new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Matrix3:function(a){var b,c,d;if(a)for(d=new Float32Array(9),c=a.elements?a.elements:a,b=0;16>b;b++)d[b]=c[b];this.elements=d||new Float32Array([1,0,0,0,1,0,0,0,1])},Vector3:function(a,b,c){var d,e=a;"object"==typeof e?(d=e.x,b=e.y,c=e.z):d=a,this.elements=new Float32Array([d||0,b||0,c||0])},Vector4:function(a,b,c,d){var e,f=a;"object"==typeof f?(e=f.x,b=f.y,c=f.z,d=f.w):e=a,this.elements=new Float32Array([e||0,b||0,c||0,d||0])}},bgl.math["static"]={Matrix4:{setScale:function(a,b,c){return new bgl.math.Matrix4([a||1,0,0,0,0,b||1,0,0,0,0,c||1,0,0,0,0,1])},setTranslate:function(a,b,c){return new bgl.math.Matrix4([1,0,0,a||0,0,1,0,b||0,0,0,1,c||0,0,0,0,1])},setRotate:function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q=new bgl.math.Matrix4;return a=Math.PI*a/180,e=q.elements,f=Math.sin(a),g=Math.cos(a),0!==b&&0===c&&0===d?(0>b&&(f=-f),e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=g,e[9]=-f,e[13]=0,e[2]=0,e[6]=f,e[10]=g,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1):0===b&&0!==c&&0===d?(0>c&&(f=-f),e[0]=g,e[4]=0,e[8]=f,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=-f,e[6]=0,e[10]=g,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1):0===b&&0===c&&0!==d?(0>d&&(f=-f),e[0]=g,e[4]=-f,e[8]=0,e[12]=0,e[1]=f,e[5]=g,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1):(h=Math.sqrt(b*b+c*c+d*d),1!==h&&(i=1/h,b*=i,c*=i,d*=i),j=1-g,k=b*c,l=c*d,m=d*b,n=b*f,o=c*f,p=d*f,e[0]=b*b*j+g,e[1]=k*j+p,e[2]=m*j-o,e[3]=0,e[4]=k*j-p,e[5]=c*c*j+g,e[6]=l*j+n,e[7]=0,e[8]=m*j+o,e[9]=l*j-n,e[10]=d*d*j+g,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1),q},setInverseOf:function(a){var b,c,d,e,f,g;if(c=a.elements,d=new bgl.math.Matrix4,g=d.elements,e=new Float32Array(16),e[0]=c[5]*c[10]*c[15]-c[5]*c[11]*c[14]-c[9]*c[6]*c[15]+c[9]*c[7]*c[14]+c[13]*c[6]*c[11]-c[13]*c[7]*c[10],e[4]=-c[4]*c[10]*c[15]+c[4]*c[11]*c[14]+c[8]*c[6]*c[15]-c[8]*c[7]*c[14]-c[12]*c[6]*c[11]+c[12]*c[7]*c[10],e[8]=c[4]*c[9]*c[15]-c[4]*c[11]*c[13]-c[8]*c[5]*c[15]+c[8]*c[7]*c[13]+c[12]*c[5]*c[11]-c[12]*c[7]*c[9],e[12]=-c[4]*c[9]*c[14]+c[4]*c[10]*c[13]+c[8]*c[5]*c[14]-c[8]*c[6]*c[13]-c[12]*c[5]*c[10]+c[12]*c[6]*c[9],e[1]=-c[1]*c[10]*c[15]+c[1]*c[11]*c[14]+c[9]*c[2]*c[15]-c[9]*c[3]*c[14]-c[13]*c[2]*c[11]+c[13]*c[3]*c[10],e[5]=c[0]*c[10]*c[15]-c[0]*c[11]*c[14]-c[8]*c[2]*c[15]+c[8]*c[3]*c[14]+c[12]*c[2]*c[11]-c[12]*c[3]*c[10],e[9]=-c[0]*c[9]*c[15]+c[0]*c[11]*c[13]+c[8]*c[1]*c[15]-c[8]*c[3]*c[13]-c[12]*c[1]*c[11]+c[12]*c[3]*c[9],e[13]=c[0]*c[9]*c[14]-c[0]*c[10]*c[13]-c[8]*c[1]*c[14]+c[8]*c[2]*c[13]+c[12]*c[1]*c[10]-c[12]*c[2]*c[9],e[2]=c[1]*c[6]*c[15]-c[1]*c[7]*c[14]-c[5]*c[2]*c[15]+c[5]*c[3]*c[14]+c[13]*c[2]*c[7]-c[13]*c[3]*c[6],e[6]=-c[0]*c[6]*c[15]+c[0]*c[7]*c[14]+c[4]*c[2]*c[15]-c[4]*c[3]*c[14]-c[12]*c[2]*c[7]+c[12]*c[3]*c[6],e[10]=c[0]*c[5]*c[15]-c[0]*c[7]*c[13]-c[4]*c[1]*c[15]+c[4]*c[3]*c[13]+c[12]*c[1]*c[7]-c[12]*c[3]*c[5],e[14]=-c[0]*c[5]*c[14]+c[0]*c[6]*c[13]+c[4]*c[1]*c[14]-c[4]*c[2]*c[13]-c[12]*c[1]*c[6]+c[12]*c[2]*c[5],e[3]=-c[1]*c[6]*c[11]+c[1]*c[7]*c[10]+c[5]*c[2]*c[11]-c[5]*c[3]*c[10]-c[9]*c[2]*c[7]+c[9]*c[3]*c[6],e[7]=c[0]*c[6]*c[11]-c[0]*c[7]*c[10]-c[4]*c[2]*c[11]+c[4]*c[3]*c[10]+c[8]*c[2]*c[7]-c[8]*c[3]*c[6],e[11]=-c[0]*c[5]*c[11]+c[0]*c[7]*c[9]+c[4]*c[1]*c[11]-c[4]*c[3]*c[9]-c[8]*c[1]*c[7]+c[8]*c[3]*c[5],e[15]=c[0]*c[5]*c[10]-c[0]*c[6]*c[9]-c[4]*c[1]*c[10]+c[4]*c[2]*c[9]+c[8]*c[1]*c[6]-c[8]*c[2]*c[5],f=c[0]*e[0]+c[1]*e[4]+c[2]*e[8]+c[3]*e[12],0===f)return null;for(f=1/f,b=0;16>b;b++)g[b]=e[b]*f;return d},setLookTo:function(a,b,c,d,e,f,g,h,i){return this.setLookAt(a,b,c,a+d,b+e,c+f,g,h,i)},setLookAt:function(a,b,c,d,e,f,g,h,i){var j,k,l,m,n,o,p,q,r,s,t=new this,u=t.elements;return arguments.length<7&&(g=i=0,h=1),arguments.length<4&&(d=e=0,f=1),p=d-a,q=e-b,r=f-c,s=1/Math.sqrt(p*p+q*q+r*r),p*=s,q*=s,r*=s,j=h*r-i*q,k=i*p-g*r,l=g*q-h*p,s=Math.sqrt(j*j+k*k+l*l),s?(s=1/s,j*=s,k*=s,l*=s):j=k=l=0,m=q*l-r*k,n=r*j-p*l,o=p*k-q*j,s=Math.sqrt(m*m+n*n+o*o),s?(s=1/s,m*=s,n*=s,o*=s):m=n=o=0,u[0]=j,u[4]=m,u[8]=p,u[12]=0,u[1]=k,u[5]=n,u[9]=q,u[13]=0,u[2]=l,u[6]=o,u[10]=r,u[14]=0,u[3]=-(j*a+k*b+l*c),u[7]=-(m*a+n*b+o*c),u[11]=-(p*a+q*b+r*c),u[15]=1,t},setPerspective:function(a,b,c,d){var e=1/Math.tan(a),f=1/(d-c),g=new this,h=g.elements;return h[0]=e/b,h[4]=0,h[8]=0,h[12]=0,h[1]=0,h[5]=e,h[9]=0,h[13]=0,h[2]=0,h[6]=0,h[10]=(d+c)*f,h[14]=1,h[3]=0,h[7]=0,h[11]=-2*c*d*f,h[15]=0,g},print:function(a){var b=this.elements;a=a||3;for(var c=0,d="";4>c;c++)d+="{0}	{1}	{2}	{3}\r\n".format(b[c].toFixed(a),b[c+4].toFixed(a),b[c+8].toFixed(a),b[c+12].toFixed(a));return console.log(d),d}},Matrix3:{},Vector3:{setCross:function(a,b){var c=a.x,d=a.y,e=a.z,f=b.x,g=b.y,h=b.z;return new bgl.math.Vector3(d*h-e*g,e*f-c*h,c*g-d*f)}}},function(){var a,b=bgl.math,c=bgl.math["static"];b.allOwnPros(function(b,d){a=c[d],a&&a.allOwnPros(function(a,c){b[c]=a})})}(),bgl.math.Matrix4.prototype={constructor:bgl.math.Matrix4,equals:function(a){if(!a)return!1;var b=a.elements,c=this.elements,d=b.length;if(b instanceof Float32Array&&c instanceof Float32Array&&c.length==d){for(var e=0;d>e;e++)if(c[e]!==b[e])return!1;return!0}return!1},save:function(){var a=this._states||[];return a.push(new Float32Array(this.elements)),this._states=a,this},forget:function(){delete this._states},restore:function(a){var b,c,d=this._states;if(d){if(b=d.length,!b)return this;a>=b&&(a=b-1),d.length=b-(a||0),c=d.pop(),this.elements=c?c:new Float32Array(this.elements.length)}return this},paste:function(a){if(a){var b,c=this.elements,d=16==a.elements.length?a.elements:new Float32Array(16);for(b=0;16>b;b++)d[b]=c[b];return a.elements=d,a}return new this.constructor(this)},copy:function(a){return this.elements=new this.constructor(a).elements,this},concat:function(a){var b,c,d,e,f,g,h,i;if(c=this.elements,d=this.elements,e=a.elements,c===e)for(e=new Float32Array(16),b=0;16>b;++b)e[b]=c[b];for(b=0;4>b;b++)f=d[b],g=d[b+4],h=d[b+8],i=d[b+12],c[b]=f*e[0]+g*e[1]+h*e[2]+i*e[3],c[b+4]=f*e[4]+g*e[5]+h*e[6]+i*e[7],c[b+8]=f*e[8]+g*e[9]+h*e[10]+i*e[11],c[b+12]=f*e[12]+g*e[13]+h*e[14]+i*e[15];return this},scale:function(a,b,c){var d=this.elements;return a=a||1,b=b||1,c=c||1,d[0]*=a,d[4]*=b,d[8]*=c,d[1]*=a,d[5]*=b,d[9]*=c,d[2]*=a,d[6]*=b,d[10]*=c,d[3]*=a,d[7]*=b,d[11]*=c,this},translate:function(a,b,c){var d=this.elements;return d[11]+=c||0,d[7]+=b||0,d[3]+=a||0,this},rotate:function(a,b,c,d){return this.concat(bgl.math.Matrix4.setRotate(a,b,c,d))},inverse:function(){return this.elements=bgl.math.Matrix4.setInverseOf(this).elements,this},transpose:function(){var a,b=this.elements;return a=b[1],b[1]=b[4],b[4]=a,a=b[2],b[2]=b[8],b[8]=a,a=b[3],b[3]=b[12],b[12]=a,a=b[6],b[6]=b[9],b[9]=a,a=b[7],b[7]=b[13],b[13]=a,a=b[11],b[11]=b[14],b[14]=a,this},lookTo:function(a,b,c,d,e,f){return this.concat(bgl.math.setLookTo(a,b,c,d,e,f))},perspective:function(a,b,c,d){return this.concat(bgl.math.Matrix4.setPerspective(a,b,c,d))}},bgl.math.Matrix3.prototype={constructor:bgl.math.Matrix3,save:bgl.math.Matrix4.prototype.save,restore:bgl.math.Matrix4.prototype.restore,paste:function(a){if(a){var b,c=this.elements,d=9==a.elements.length?a.elements:new Float32Array(9);for(b=0;9>b;b++)d[b]=c[b];return a.elements=d,d}return new this.constructor(this)},forget:function(){delete this._states},copy:bgl.math.Matrix4.prototype.copy},bgl.math.Vector3.prototype={constructor:bgl.math.Vector3,set x(a){this.elements[0]=a},set y(a){this.elements[1]=a},set z(a){this.elements[2]=a},get x(){return this.elements[0]},get y(){return this.elements[1]},get z(){return this.elements[2]},concat:function(a){var b,c,d,e,f=this.elements,g=a.elements;switch(a.elements.length){case 3:for(c=0;3>c;c++)f[c]=f[c]*g[c];break;case 9:for(b=new Float32Array(3),c=0,d=0;3>c;c++,d+=3)b[c]=f[0]*g[d]+f[1]*g[d+1]+f[2]*g[d+2];this.elements=b;break;case 16:for(b=new Float32Array(3),e=f[0]*g[12]+f[1]*g[13]+f[2]*g[14]+g[15],c=0,d=0;3>c;c++,d+=4)b[c]=(f[0]*g[d]+f[1]*g[d+1]+f[2]*g[d+2]+g[d+3])/e;this.elements=b}return this},translate:function(a,b,c){return this.elements[0]+=a||0,this.elements[2]+=c||0,this.elements[1]+=b||0,this},normalize:function(){var a=this.elements,b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d);return e&&1==e?this:(0==e?a[0]=a[1]=a[2]=0:(e=1/e,a[0]=b*e,a[1]=c*e,a[2]=d*e),this)},dot:function(a){var b=this.elements,c=a.elements;return b[0]*c[0]+b[1]*c[1]+b[2]*c[2]},cross:function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z,h=this.elements;return h[0]=c*g-d*f,h[1]=d*e-b*g,h[2]=b*f-c*e,this},len:function(){return this.dot(this)},paste:function(a){var b=this.elements;if(a){for(var c=3==a.elements.length?a.elements:new Float32Array(3),d=0;3>d;d++)c[d]=b[d];return a.elements=c,a}return new this.constructor(b[0],b[1],b[2])},minus:function(a,b,c){var d,e=this.elements;return"number"!=typeof a?(d=a.x||0,b=a.y||0,c=a.z||0):d=a,e[0]-=d,e[1]-=b,e[2]-=c,this},plus:function(a,b,c){var d=this.elements;return"number"!=typeof a&&(a=a.x||0,b=a.y||0,c=a.z||0),d[0]+=a,d[1]+=b,d[2]+=c,this},rotate:function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q=1/Math.sqrt(b*b+c*c+d*d),r=a/180*Math.PI,s=this.elements,t=s[0],u=s[1],v=s[2];return e=Math.sin(r),f=Math.cos(r),g=1-f,1!==q&&(b*=q,c*=q,d*=q),b===c&&0===c?(s[0]=t*f-u*e,s[1]=t*e+u*f,s[2]=v):b===d&&0==d?(s[0]=v*e+t*f,s[1]=u,s[2]=v*f-t*e):c===d&&0==c?(s[0]=t,s[1]=u*f-v*e,s[2]=u*e+v*f):(h=b*b*g+f,i=c*b*g+d*e,j=d*b*g-c*e,k=b*c*g-d*e,l=c*c*g+f,m=d*c*g+b*e,n=b*d*g+c*e,o=c*d*g-b*e,p=d*d*g+f,s[0]=h*t+i*u+j*v,s[1]=k*t+l*u+m*v,s[2]=n*t+o*u+p*v),this},copy:bgl.math.Matrix4.prototype.copy,save:bgl.math.Matrix4.prototype.save,forget:function(){delete this._states},restore:bgl.math.Matrix4.prototype.restore,equals:bgl.math.Matrix4.prototype.equals},bgl.math.Vector4.prototype={constructor:bgl.math.Vector4,get x(){return this.elements[0]},get y(){return this.elements[1]},get z(){return this.elements[2]},get w(){return this.elements[3]},paste:function(a){var b=this.elements;if(a){for(var c=4==a.elements.length?a.elements:new Float32Array(4),d=0;4>d;d++)c[d]=b[d];return a.elements=c,a}return new this.constructor(b[0],b[1],b[2],b[3])},forget:function(){delete this._states},restore:bgl.math.Matrix4.prototype.restore,save:bgl.math.Matrix4.prototype.save,copy:bgl.math.Matrix4.prototype.copy},bgl.animation={SimpleClock:function(a,b,c,d,e,f){this.duration=a||0,this.direction=c||1,this.timingFunction=e||bgl.animation.TimingFunctions.linear,this.multiplier=b||1,this.offset=d||0,this._startTime=-1,this.d=this.direction,this.t=1==this.d?0:1,this._stopped=!0,this.value=this.offset,this.infinite=f||!1,this._timeline=null},TimeLine:function(a){this._now=this._stopTime=0,this._startTime=this._lastStop=Date.now(),this._scene=a,this._isStop=!0}},bgl.animation.SimpleClock.prototype={get refer(){return this._refer},get scene(){var a=this.refer;return a?a.scene:null},waitUpdate:function(){var a=this.scene;a?a.add(this):this._waitUpdate=!0},start:function(){return this.t!=(1==this.direction?0:1)?!1:(this._startTime=-1,this.d=this.direction,this.t=1==this.d?0:1,this._stopped=!1,this.value=this.t*this.multiplier+this.offset,this.waitUpdate(),!0)},restart:function(){this.t=1==this.direction?0:1,this.start()},reset:function(a){a instanceof bgl.animation.TimeLine&&(this._timeline=a),this._startTime=-1,this.d=this.direction,this.t=1==this.d?0:1,this.value=this.t*this.multiplier+this.offset,this._stopped=!0},end:function(a){a instanceof bgl.animation.TimeLine&&(this._timeline=a),this._startTime=-1,this.d=this.direction,this.t=1==this.d?1:0,this.value=this.t*this.multiplier+this.offset,this._stopped=!0},set ontick(a){this.on("update",a)},reverse:function(){return this.t!=(1==this.direction?1:0)?!1:(this._startTime=-1,this._stopped=!1,this.d=-this.direction,this.t=1==this.d?0:1,this.value=this.t*this.multiplier+this.offset,this.waitUpdate(),!0)},toggle:function(){0==this.t?this.restart():1==this.t&&this.reverse()},update:function(a){if(this._stopped)a.scene.remove(this);else{if(-1==this._startTime)return this._startTime=a.now,!0;var b=(a.now-this._startTime)/a.ticksPerSecond;if(b>0){var c=this.value;switch(this.t=1==this.d?b/this.duration:1-b/this.duration,this.t>1?this.t=1:this.t<0&&(this.t=0),this.value=this.timingFunction.apply(bgl.animation.TimingFunctions,[this.t])*this.multiplier+this.offset,this.t){case 0:this._stopped=!0,this.emit("reverse",[c,a]),this.infinite&&this.restart();break;case 1:this._stopped=!0,this.emit("end",[c,a]),this.infinite&&this.reverse();break;default:c!=this.value&&this.emit("update",[c,a])}return!0}delete this._waitUpdate}return!1}},bgl.animation.TimeLine.prototype={get now(){return this._now},get isStopped(){return this._isStop},get scene(){return this._scene},ticksPerSecond:1e3,stop:function(){this._isStop||(this._isStop=!0,this._lastStop=Date.now())},start:function(){this._isStop&&(this._isStop=!1,this._stopTime+=Date.now()-this._lastStop)},tick:function(){this._isStop||(this._now=Date.now()-this._startTime-this._stopTime)}},bgl.animation.TimingFunctions={linear:function(a){return a},sineEaseIn:function(a){return-Math.cos(a*(Math.PI/2))+1},sineEaseOut:function(a){return Math.sin(a*(Math.PI/2))},sineEaseInOut:function(a){return-.5*(Math.cos(Math.PI*a)-1)},quintEaseIn:function(a){return a*a*a*a*a},quintEaseOut:function(a){return a--,a*a*a*a*a+1},quintEaseInOut:function(a){return a/=.5,1>a?.5*a*a*a*a*a:(a-=2,.5*(a*a*a*a*a+2))},quartEaseIn:function(a){return a*a*a*a},quartEaseOut:function(a){return a--,-(a*a*a*a-1)},quartEaseInOut:function(a){return a/=.5,1>a?.5*a*a*a*a:(a-=2,-.5*(a*a*a*a-2))},circEaseIn:function(a){return-(Math.sqrt(1-a*a)-1)},circEaseOut:function(a){return a--,Math.sqrt(1-a*a)},circEaseInOut:function(a){return a/=.5,1>a?-.5*(Math.sqrt(1-a*a)-1):(a-=2,.5*(Math.sqrt(1-a*a)+1))},quadEaseIn:function(a){return a*a},quadEaseOut:function(a){return-1*a*(a-2)},quadEaseInOut:function(a){return a/=.5,1>a?.5*a*a:(a--,-.5*(a*(a-2)-1))},cubicEaseIn:function(a){return a*a*a},cubicEaseOut:function(a){return a--,a*a*a+1},cubicEaseInOut:function(a){return a/=.5,1>a?.5*a*a*a:(a-=2,.5*(a*a*a+2))},bounceEaseOut:function(a){return 1/2.75>a?7.5625*a*a:2/2.75>a?(a-=1.5/2.75,7.5625*a*a+.75):2.5/2.75>a?(a-=2.25/2.75,7.5625*a*a+.9375):(a-=2.625/2.75,7.5625*a*a+.984375)},bounceEaseIn:function(a){return 1-this.bounceEaseOut(1-a)},bounceEaseInOut:function(a){return.5>a?.5*this.bounceEaseIn(2*a):.5*this.bounceEaseOut(2*a-1)+.5},expoEaseIn:function(a){return 0==a?0:Math.pow(2,10*(a-1))},expoEaseOut:function(a){return 1==a?1:-Math.pow(2,-10*a)+1},expoEaseInOut:function(a){return 0==a?0:1==a?1:1>a/.5?.5*Math.pow(2,10*(a/.5-1)):.5*(-Math.pow(2,-10*(a/.5-1))+2)},zeroStep:function(a){return 0>=a?0:1},halfStep:function(a){return.5>a?0:1},oneStep:function(a){return a>=1?1:0},random:function(){return Math.random()},randomLimit:function(a){return Math.random()*a}},function(){function a(a){this.registerHandlers(a),this.minMoveDistance=8,this.skipFrameNum=2,this.shouldClear=!0,this.preventAll=!1,this._skipped=0,this.pEvents={},this.kEvents=[],this.keyDefinition={codes:[],index:[],names:[]},this._lastPoints={},this._lastKey=null}function b(a){switch(a){case 0:return"unknown";case 1:return"press";case 2:return"click";case 3:return"drag";case 4:return"release";case 5:return"move";default:return void 0}}function c(a,c){return c.toLowerCase()==b(a)}function d(a,b){this.action=b,this.keyCode=a.keyCode||a.which,this.defination=void 0,this.repeat=1,this.event=b==f.DOWN?g.PRESS:g.RELEASE,this.startTime=this.timeStamp=Date.now()}function e(a,b){if(void 0==a.identifier)a.identifier="mouse";else{var c=a.target;a.offsetX=a.clientX-c.clientLeft-c.offsetLeft,a.offsetY=a.clientY-c.clientTop-c.offsetTop}this.identifier=a.identifier,this.action=b,this.clientX=a.clientX,this.clientY=a.clientY,this.offsetX=a.offsetX,this.offsetY=a.offsetY,this.dx=this.dy=0,this.accumulatedX=this.accumulatedY=0,this.event=g.NULL,this.startTime=this.timeStamp=Date.now()}var f={DOWN:1,MOVE:0,UP:2},g={NULL:0,PRESS:1,CLICK:2,DRAG:3,RELEASE:4,MOVE:5};a.prototype={get shouldSkipFrame(){return this._skipped<this.skipFrameNum},get lastPointEvents(){var a,b,c=[],d=this.pEvents;return d.allOwnPros(function(e,f){b=e.length,0==b?delete d[f]:a=e[b-1],void 0!=a&&(a.identifier=f,c.push(a))}),c},get lastKeyEvents(){return this.kEvents.slice(-1)},ignoreEvent:function(a,b){return b instanceof e?this.minMoveDistance>Math.abs(b.clientX-a.clientX)+Math.abs(b.clientY-a.clientY):!1},registerHandlers:function(a){if(a instanceof HTMLElement&&!a.eventPool){var b=this,c=function(a){return a.preventDefault(),a.stopPropagation(),!1};h.allOwnPros(function(d,e){"function"==typeof d?(a.addEventListener(e,d.bind(b),!0),a.addEventListener(e,c,!0)):document.addEventListener(e,d.fun.bind(b))}),a.eventPool=b,b.element=a}},clear:function(){var a=this.pEvents,b=Object.getOwnPropertyNames(a),c=this._lastPoints;b.remove("mouse"),b.forEach(function(a){c[a]&&c[a].action!=f.UP||delete c[a]}),this.pEvents={},this.kEvents=[]},update:function(a){if(this.preventAll)return this.clear();var b=this.lastKeyEvents.concat(this.lastPointEvents);this.shouldSkipFrame?this._skipped+=1:(this.shouldClear=!0,this.emit("update",[b,a]),this.shouldClear&&this.clear(),this._skipped=0)},add:function(a){var b,c;return a instanceof e?(b=this.pEvents[a.identifier],b||(this.pEvents[a.identifier]=b=[]),c=this._lastPoints[a.identifier],a.combine(c)||(b.push(a),this._lastPoints[a.identifier]=a)):a instanceof d&&(a.combine(this._lastKey)||(this.kEvents.push(a),this._lastKey=a,a.defination=this.getKeyDefinition(a.keyCode))),this},addKeyDefinition:function(a,b){var c,d=this.keyDefinition,e=d.codes,f=d.names;if(arguments.length>2)for(var g=1,h=this.addKeyDefinition.bind(this,a),i=arguments[g];i;i=arguments[++g])h(i);else{if(e.indexOf(b)>-1)return this;c=f.indexOf(a),-1==c&&(f.push(a),c=f.length-1),e.push(b),d.index.push(c)}return this},getKeyDefinition:function(a){var b=this.keyDefinition,c=b.index[b.codes.indexOf(a)];return void 0==c?void 0:b.names[c]},getKeyCodes:function(a){var b=this.keyDefinition,c=b.names.indexOf(a);if(0>c)return void 0;for(var d=0,e=b.index,f=e.length,g=[],h=b.codes;f>d;d++)e[d]==c&&g.push(h[d]);return g},hasCodeDefinition:function(a){return-1!=this.keyDefinition.codes.indexOf(a)},set onupdate(a){"function"==typeof a&&this.on("update",a)}},e.prototype={combine:function(a){if(!a)switch(this.action){case f.DOWN:return this.event=g.PRESS,!1;case f.MOVE:return this.event=g.MOVE,!1;case f.UP:return this.event=g.CLICK,!0;default:throw""}var b=a.event;switch(this.dx=this.clientX-a.clientX,this.dy=this.clientY-a.clientY,this.action){case f.DOWN:switch(this.event=g.PRESS,b){case g.DRAG:return a.event=g.RELEASE,!1;case g.PRESS:return a.event=g.NULL,!1;default:return!1}case f.MOVE:switch(this.startTime=a.startTime,this.accumulatedX=a.accumulatedX+this.dx,this.accumulatedY=a.accumulatedY+this.dy,b){case g.DRAG:return this.event=g.DRAG,!1;case g.PRESS:return this.event=g.DRAG,!1;default:return b!==g.MOVE&&(this.startTime=this.timeStamp),this.event=g.MOVE,!1}case f.UP:switch(this.startTime=a.startTime,b){case g.PRESS:return this.event=g.CLICK,!1;case g.DRAG:return this.accumulatedX=a.accumulatedX+this.dx,this.accumulatedY=a.accumulatedY+this.dy,this.event=g.RELEASE,!1;default:return this.event=g.NULL,!0}}throw""},equalType:function(a){return c(this.event,a)},get eventType(){return b(this.event)},get defination(){return b(this.event)},type:"point"},d.prototype={combine:function(a){if(!a)return!1;if(a.event==g.PRESS){if(this.action==f.DOWN)return this.event=g.PRESS,this.repeat+=a.repeat,a.event=g.NULL,!1;if(1==a.repeat)return this.event=g.CLICK,!0}return!1},equalType:function(a){return c(this.event,a)},get eventType(){return b(this.event)},type:"key",identifier:"key"};var h={click:function(){},mousedown:function(a){this.add(new e(a,f.DOWN))},mouseup:function(a){this.add(new e(a,f.UP))},mousemove:function(a){var b,c=new e(a,f.MOVE),d=this.pEvents[c.identifier];d&&d.length>0&&(b=d[d.length-1]),this.ignoreEvent(c,b)||this.add(c)},keydown:{fun:function(a){this.hasCodeDefinition(a.keyCode)&&this.add(new d(a,f.DOWN))}},keyup:{fun:function(a){this.hasCodeDefinition(a.keyCode)&&this.add(new d(a,f.UP))}},touchstart:function(a){for(var b=0,c=a.changedTouches,d=c[0];d;d=c[++b])h.mousedown.apply(this,[d])},touchmove:function(a){for(var b=0,c=a.changedTouches,d=c[0];d;d=c[++b])h.mousemove.apply(this,[d])},touchend:function(a){for(var b=0,c=a.changedTouches,d=c[0];d;d=c[++b])h.mouseup.apply(this,[d])},touchcancel:function(a){for(var b=0,c=a.changedTouches,d=c[0];d;d=c[++b])h.mouseup.apply(this,[d])}},i={};return i.getEventPool=function(b){var c=b.eventPool;return c||(c=new a(b)),c},window.bgl&&(window.bgl.event=i),i}(),bgl.foundation={Binder:function(a,b,c){this.name=a,b&&(this.bind=b),c&&(this.dispose=c)},Attribute:function(a,b,c,d){this.name=a,this._stride=c||0,this._offset=d||0,b instanceof bgl.resource.Buffer||(b=new bgl.resource.Buffer(b)),this._buffer=b,this._invalid=!0},AttributeEntry:function(a,b,c){var d;switch(a){case"vec2":d=2;break;case"vec3":d=3;break;case"vec4":d=4;break;case"float":d=1}this._size=d,this._loc=b,this._program=c,this._bindingAttribute=null,c.gl.enableVertexAttribArray(b)},Uniform:function(a,b,c,d){this.name=a,this._val=b,c=c||b.getter,c&&(this.getter=c),this._entry=null,d&&(this.alwaysBind=!0)},UniformEntry:function(a,b,c){this._type=a,this.value=void 0,this._loc=b,this._program=c,this._invalid=!0,this._bindingUniform=null},Sampler2D:function(a,b,c,d,e,f){this.name=a,this.onload=c,this.onerror=d,b instanceof Image?this.img=b:"string"==typeof b&&(this.img=new Image,this._img.src=b),this._texture=new bgl.resource.Texture(!1),this._buffered=!1,this.flipY=f?1:0,this.imgParam={TEXTURE_MAG_FILTER:"LINEAR",TEXTURE_MIN_FILTER:"LINEAR",TEXTURE_WRAP_S:e?"REPEAT":"CLAMP_TO_EDGE",TEXTURE_WRAP_T:e?"REPEAT":"CLAMP_TO_EDGE"}},SamplerCube:function(a,b,c,d,e,f,g,h,i,j){this.name=a,this.imgs={},this._texture=new bgl.resource.Texture(!0),this._buffered=!1,this._ready=!1,this._loaded=0,this.onsuccess=i,this.onfail=j,this.imgParam={TEXTURE_MAG_FILTER:"LINEAR",TEXTURE_MIN_FILTER:"LINEAR",TEXTURE_WRAP_S:"CLAMP_TO_EDGE",TEXTURE_WRAP_T:"CLAMP_TO_EDGE"};var k=this.wrapImg.bind(this),l=b||"";k(l+d,"NEGATIVE_X"),k(l+f,"NEGATIVE_Y"),k(l+h,"NEGATIVE_Z"),k(l+c,"POSITIVE_X"),k(l+e,"POSITIVE_Y"),k(l+g,"POSITIVE_Z")}},bgl.foundation.SamplerCube.prototype={get texture(){return this._texture},get buffered(){return this._buffered&&this._texture._buffered},getter:function(){return this._texture._index},bind:function(a){this.bufferData(a)||this._texture.bind(a),this._entry.bind(a,this)},releaseTexture:function(){this._buffered=!1,this._texture.refer=null,this._texture=null},bufferData:function(a){if(this._ready&&!this.buffered){{var b,c=this.imgs,d=this.imgParam,e=this.texture;a.cfg}e.bind(a);for(var f in c)c.hasOwnProperty(f)&&(b=c[f],a.texImage2D(a["TEXTURE_CUBE_MAP_"+f],0,a.RGB,a.RGB,a.UNSIGNED_BYTE,b),delete b.onload,delete b.onunload);for(var g in d)d.hasOwnProperty(g)&&a.texParameteri(a.TEXTURE_CUBE_MAP,a[g],a[d[g]]);return this._buffered=!0,this._entry=a.cfg.curProgram.uniforms[this.name],delete this.onsuccess,delete this.onfail,!0}return!1},wrapImg:function(a,b){var c=new Image;c.crossOrigin="",c.loader=this,c.onload=this.onload.bind(this),c.onunload=this.onunload.bind(this),c.src=a,this.imgs[b]=c},onunload:function(){console.log("TextureCubic load Fail:"+this._loc),this.onfail&&this.onfail(this),delete this.onsuccess,delete this.onfail},onload:function(){6==++this._loaded&&(this._ready=!0,this.onsuccess&&this.onsuccess(this))},dispose:function(){var a=this.texture;a&&a.dispose(),delete this.imgs}},bgl.foundation.Sampler2D.prototype={get buffered(){return this._buffered&&this._texture._buffered},set onload(a){"function"==typeof a&&this.on("load",a)},set onerror(a){"function"==typeof a&&this.on("error",a)},set onchanage(a){"function"==typeof a&&this.on("change",a)
},set img(a){var b=this._img,c=this;a instanceof Image&&b!==a&&(this._img=a?a:null,this.emit("change",[b,c]),a&&(a.complete&&a.src?setTimeout(function(){c.emit("load",[a,this])},1):(a.addEventListener("load",function(a){c.emit("load",[a.target,c])}),a.addEventListener("error",function(a){console.log("img fail",a),c.emit("error",[a.target,c])}))),this._buffered=!1)},get img(){return this._img},bufferData:function(a){if(this.buffered)return!1;var b=this.img,c=this.imgParam,d=this._texture;if(d.bind(a),b){if(b.complete){a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,this.flipY),a.texImage2D(a.TEXTURE_2D,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,b);for(var e in c)c.hasOwnProperty(e)&&a.texParameteri(a.TEXTURE_2D,a[e],a[c[e]]);Math.isInt(Math.log2(b.width*b.height))&&a.generateMipmap(a.TEXTURE_2D)}}else a.texImage2D(a.TEXTURE_2D,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,null);return this._entry=a.cfg.curProgram.uniforms[this.name],this._buffered=!0,!0},getter:function(){return this._texture._index},bind:function(a){this.bufferData(a)||this._texture.bind(a),this._entry.bind(a,this)},releaseTexture:function(){this._buffered=!1,this._texture.refer=null,this._texture=null},dispose:function(){var a=this.texture;a&&a.dispose(),delete this._img}},bgl.foundation.Uniform.prototype={bind:function(a){return this._entry||(this._entry=a.cfg.curProgram.uniforms[this.name]),this._entry.bind(a,this)},get value(){return this._entry&&this._entry.invalid(),this._val},set value(a){this._val=a,this._entry&&this._entry.invalid()},dispose:function(){this._val.dispose&&this._val.dispose()},invalid:function(){var a=this._entry;a&&a.invalid()}},bgl.foundation.UniformEntry.prototype={get bindingUniform(){var a=this._bindingUniform;return a&&!this._invalid?a:null},setters:{mat4:function(a,b){a.uniformMatrix4fv(this._loc,!1,b.elements)},mat3:function(a,b){a.uniformMatrix3fv(this._loc,!1,b.elements)},vec3:function(a,b){a.uniform3fv(this._loc,b.elements)},"float":function(a,b){a.uniform1f(this._loc,b)},sampler2D:function(a,b){a.uniform1i(this._loc,b)},samplerCube:function(a,b){a.uniform1i(this._loc,b)},"int":function(a,b){a.uniform1i(this._loc,b)},vec4:function(a,b){a.uniform4fv(this._loc,b.elements)}},invalid:function(){this._program.gl.cfg.curScene.invalid(),this._invalid=!0},change:function(a){var b=this._bindingUniform;if(b){var c=b._val,d=a(c);return this.value=void 0===d?c:d,this.invalid(),!0}return!1},bind:function(a,b){if(this.bindingUniform===b)return!1;var c=b.getter?b.getter.apply(b,[b._val,a.cfg]):b._val;return this.setters[this._type].apply(this,[a,c]),this.value=c,this._bindingUniform=b,this._invalid=b.alwaysBind,!0}},bgl.foundation.Attribute.prototype={invalid:function(){var a=this._entry;a&&a.invalid()},get data(){return this._buffer.data},set data(a){this._buffer.data=a,this.invalid()},get buffered(){return this._buffer.buffered},bind:function(a){var b=this._entry;b||(b=a.cfg.curProgram.attributes[this.name],this._entry=b,this._size=b._size,this._loc=b._loc),this._buffer.bind(a),a.vertexAttribPointer(this._loc,this._size,a.FLOAT,!1,this._stride,this._offset)},bufferData:function(a){this._buffer.bufferData(a)},dispose:function(){this._buffer&&this._buffer.dispose()}},bgl.foundation.AttributeEntry.prototype={invalid:function(){this._program.gl.cfg.curScene.invalid()},change:function(a){var b=this._bindingAttribute;return b?(a(b),this.invalid(),!0):!1}},bgl.foundation.Binder.prototype={dispose:function(){},bind:function(){return!1}},bgl.model={Geometry:function(a,b,c,d,e){this.binders=b||{},this.drawMode=e||WebGLRenderingContext.TRIANGLES,a?this.indexBuffer=a instanceof bgl.resource.Buffer?a:new bgl.resource.Buffer(a,WebGLRenderingContext.ELEMENT_ARRAY_BUFFER):this.draw=function(){},this._culler=new bgl.cull.CullLeaf(this,c,d),this._hittable=!1,this._parent=null,this._controller=null,this._settings={alwaysCulled:null}},Camera:function(a,b,c,d){var e=bgl.math.Vector3;a=a||0,this._near=a.near||.01,this._far=a.far||1.01,this._aspect=a.aspect||1,this._fovy=(a.fovy||60)/180*Math.PI,this._at=b instanceof e?b:b=new e(0,0,0),this._front=c instanceof e?c.minus(b).normalize():b.paste().minus(0,0,-1),this._top=d instanceof e?d.minus(b).normalize():b.paste().minus(0,-1,0),this._scene=a.scene,this.freeze=!1,this._invalid=!0},Render:function(a,b){this._scene=null,this._parent=null,this._children=[],this._geometries=[],this._controller=null,this._culler=new bgl.cull.CullNode(this,b),this.binders=a||{},this._invalid=!0,this._depth=0,this._hittable=!1,this._settings={alwaysCulled:null}},Scene:function(a){this._camera=a instanceof bgl.model.Camera?a:new bgl.model.Camera({scene:this}),this._rootRender=new bgl.model.Render,this._activeControllers=[],this._detectors=[],this._colliders=[],this._timeline=new bgl.animation.TimeLine(this),this._invalid=!0,this.cfg=null,this._settings={asyncCull:!0,discard:!1},this._rootRender._scene=this,this._camera.invalid()},Collider:function(a,b,c,d){this.scene=null,"function"==typeof a?this.getter=a:a&&(this._wBound=a),this.reuse=c||!1,this.ignoreCull=d||!1,this.maxTargets=b||256,this._collidedDetectors=[],this._invalid=!0},Detector:function(a,b){this.worldBound=a,this.ignoreCull=b||!1,this.culled=null,this.scene=null}},bgl.model.Collider.prototype={event:{collided:"collided",depart:"depart",fullfill:"complete"},get worldBound(){var a=this.getter;return a?a(this):this._wBound},set onCollided(a){"function"==typeof a&&this.on(this.event.collided,a)},set onDepart(a){"function"==typeof a&&this.on(this.event.depart,a)},set onComplete(a){"function"==typeof a&&this.on(this.event.fullfill,a)},emitCollision:function(a,b){b.emit(a,[this]),this.emit(a,[b])},collide:function(a){if(!(a instanceof Array))return[];for(var b,c=this._collidedDetectors,d=c.concat(),e=this.ignoreCull,f=[],g=this.maxTargets,h=0,i=d[0];i;i=d[++h])i.detect(this)||(this.emitCollision(this.event.depart,i),c.remove(i));for(b=a.filter(function(a){return d.indexOf(a)<0}),h=0,i=b[0];i;i=b[++h]){if(g<=f.length)return f;(e||i.ignoreCull||i.culled===!1)&&i.detect(this)&&(f.add(i),c.add(i),this.emitCollision(this.event.collided,i))}return f},invalid:function(){return this._invalid||(this._invalid=!0),this},reset:function(){return this._invalid=!1,this}},bgl.model.Detector.prototype={event:bgl.model.Collider.prototype.event,set onCollided(a){"function"==typeof a&&this.on(this.event.collided,a)},set onDepart(a){"function"==typeof a&&this.on(this.event.depart,a)},get culler(){return this},detect:function(a){return this.worldBound.overlap(a.worldBound)},cull:function(a){var b;return b=this.culled=!a.contains(this.worldBound)}},bgl.model.Scene.prototype={set discard(a){this._settings.discard=!!a},get discard(){return this._settings.discard},get enable(){return this._enable!==!1},set enable(a){var b=this._enable;a!=b&&(this._enable=a,this.invalid())},get asyncCull(){return this._settings.asyncCull},set asyncCull(a){this.asyncCull!=a&&(this._settings.asyncCull=a),this.invalid()},get rootRender(){return this._rootRender},get camera(){return this._camera},set rootRender(a){var b=this._rootRender;a instanceof bgl.model.Render&&a!==b&&(b&&(b._scene=null),this._rootRender=a,a._scene=this,this.camera.invalid())},set camera(a){var b=this._camera;a instanceof bgl.model.Camera&&a!==b&&(b&&(b._scene=null),this._camera=a,a._scene=this,a.invalid())},invalid:function(){return this._invalid=!0,this},update:function(a){var b=this._timeline;b.tick();for(var c=0,d=this._activeControllers,e=d[0];e;e=d[++c])e.update(b);this.emit("update",[a])},cull:function(a,b,c){this.rootRender.cull(a,b||this.asyncCull,c||this.camera)},render:function(a,b){if(this.enable){this.update(b);var c=this.camera,d=this.asyncCull;this.discard||this.detectCollision(c),this.discard||!this._invalid&&!c._invalid||(c.freeze=!0,d&&(this.cull(c._invalid,!0,c),this._camera._invalid=!1),this.discard||this.rootRender.render(a,b,d),c._invalid=c.freeze=!1,this._invalid=!1,this.discard=!1)}},detectCollision:function(a,b){var c,d,e,f,g,h,i;if(a=a||this.camera,c=b||(a._invalid?this._colliders:this._colliders.filter(function(a){return a._invalid})),0!=c.length){for(d=this._detectors,e=0,g=d[0];g;g=d[++e])(a._invalid||null==g.culled)&&g.culler.cull(a,!1);for(h=[],i=c[0].event.fullfill,e=0,f=c[0];f;f=c[++e])f.emit(i,[f.collide(d)],f),f.reuse&&h.add(f.reset());this._colliders=h}},dispose:function(a){this._camera._scene=null,this.rootRender.dispose(a),this._activeControllers.forEach(function(b){b.dispose(a)}),delete this._rootRender,delete this._camera},add:function(a){var b=!1;return a instanceof bgl.model.Render||a instanceof bgl.model.Geometry?b=this.rootRender.add(a):a instanceof bgl.model.Collider&&this._colliders.add(a)?(b=!0,a.scene=this):a instanceof bgl.model.Detector&&this._detectors.add(a)?(b=!0,a.scene=null):a.update&&this._activeControllers.add(a)&&(a._scene=this,b=!0),b&&this.invalid(),this},remove:function(a){var b=!1;return a instanceof bgl.model.Render||a instanceof bgl.model.Geometry?b=this.rootRender.remove(a):a instanceof bgl.model.Collider?b=this._colliders.remove(a):a instanceof bgl.model.Detector?(b=this._detectors.remove(a),a.scene=null):a.update&&this._activeControllers.remove(a)&&(a._scene=null,b=!0),b&&this.invalid(),this}},bgl.model.Render.prototype={detect:function(a){return this.worldBound.overlap(a.worldBound)},dispose:function(a){var b=function(b){b.dispose(a)},c=this._controller;c&&(c._scene&&c._scene.remove(c),c.dispose(a),c._scene=null,c._refer=null),this._culler.dispose(),this.binders.allOwnPros(b),this._geometries.forEach(b),this._children.forEach(b),this._settings={alwaysCulled:null},this._parent=null,this._scene=null},invalid:function(){var a=this.scene;return a&&a.invalid(),this},bind:function(a,b){for(var c=this.binders,d=Object.getOwnPropertyNames(c),e=0,f=d[0];f;f=d[++e])c[f].bind(a,b)},update:function(a){a.curRender=this,a.curProgram=this.program},render:function(a,b,c){var d,e,f;if(this.enable&&(this.update(b),c||null!==this.culled||this.cull(!1,!1,b.curCamera),this.culled===!1)){for(this.bind(a,b),d=0,e=this._geometries,f=e[0];f;f=e[++d])f.render(a,b);for(d=0,e=this._children,f=e[0];f;f=e[++d])f.render(a,b,c)}},cull:function(a,b,c){(a||null===this.culled)&&this.culler.cull(c,b)},set hittable(a){var b,c=this._hittable;a=!!a,c!=a&&(this._hittable=a,b=this.scene,b&&(a?b._detectors.add(this):b._detectors.remove(this)))},get hittable(){return this._hittable},get enable(){return this._enable!==!1},set enable(a){var b=this._enable;a!=b&&(this._enable=a,this.invalid())},get program(){return this._program},set program(a){this._program=a,this.invalid()},get scene(){return this.parent?this.parent.scene:this._scene},get parent(){return this._parent},get culler(){return this._culler},get worldBound(){return this._culler.worldBound},get worldMatrix(){return this._culler.worldMatrix},set modelMatrix(a){this._culler.modelMatrix=a},get modelMatrix(){return this._culler.modelMatrix},get culled(){var a=this._settings.alwaysCulled;return null===a?this._culler._culled:a},get controller(){return this._controller},set controller(a){var b=this.controller;if(b!==a){var c=this.scene;b&&(c&&c.remove(b),b._refer=null),this._controller=a,a&&(a._waitUpdate&&c&&c.add(a),a._refer=this)}},findBinder:function(a){var b=this.binders[a];if(!b){for(var c=0,d=this._geometries,e=d[0];e;e=d[++c])if(b=e.findBinder(a))return b;for(c=0,d=this._children,e=d[0];e;e=d[++c])if(b=e.findBinder(a))return b}return b},concat:function(a){return this._culler.concat(a),this.invalid()},add:function(a){if(arguments.length>1)for(var b=0,c=arguments[0];c;c=arguments[++b])this.add(c);else{if(a.parent)return!1;if(!(a instanceof bgl.model.Render&&this._children.add(a)||a instanceof bgl.model.Geometry&&this._geometries.add(a)))return!1;this._culler.add(a._culler),a._parent=this,a._depth=this._depth+1;var c=a.controller,d=this.scene;d&&(c&&c._waitUpdate&&d.add(c),a.hittable&&d._detectors.add(a)),this.invalid()}return!0},remove:function(a){var b=(a._geometries?this._children:this._geometries).remove(a);if(b){var c=this.scene;c&&(c._activeControllers.remove(this._controller),c._detectors.remove(this)),a._parent=null,this._culler.remove(a._culler),this.invalid()}return b},addBinder:function(a,b){if("function"==typeof a&&b&&(a=new bgl.foundation.Binder(b,a)),b=b||a.name,!b||!a.bind||!a.dispose)throw"cannot add";return this.binders[b]=a,a.refer=this,this},removeBinder:function(a){{var b=this.binders;b[a]}return b[a]=void 0,this},save:function(){return this._culler.save(),this},forget:function(){return this._culler.forget(),this},restore:function(a){return this._culler.restore(a),this}},bgl.model.Camera.prototype={get at(){return this._at},get up(){var a=this._up;return a||(this._up=a=this._top.paste().minus(this._at)),a.paste()},get to(){var a=this._to;return a||(this._to=a=this._front.paste().minus(this._at)),a.paste()},get right(){return this.to.constructor.setCross(this.up,this.to)},get fovy(){return this._fovy/Math.PI*180},set fovy(a){var b=this.fovy;isNaN(a)||a>=180||b==a||(this._fovy=a/180*Math.PI,this.reset())},invalid:function(){return this._invalid||(this._invalid=!0,this.scene&&this.scene.invalid()),this},save:function(){var a={_at:this._at.paste(),_front:this._front.paste(),_top:this._top.paste()},b=this._states||[];return this.allOwnPros(function(b,c){"object"!=typeof b&&"_"==c[0]&&(a[c]=b)}),b.push(a),this._states=b,this},forget:function(){return delete this._states,this},restore:function(a){var b,c,d,e=this._states;if(e){if(c=e.length,!c)return this;a>=c&&(a=c-1),e.length=c-(a||0),b=e.pop(),d=this,b.allOwnPros(function(a,b){d[b]=a}),this._states=e}return this},reset:function(){return this._vMatrix=null,this._wBound=null,this._pMatrix=null,this._vpMatirx=null,this._up=null,this._to=null,this.invalid()},_constructBound:function(){var a=this.mvpMatrix().inverse(),b=bgl.math.Vector3,c=[new b(1,1,0),new b(-1,1,0),new b(1,-1,0),new b(-1,-1,0),new b(1,1,1),new b(-1,1,1),new b(1,-1,1),new b(-1,-1,1)];return c.forEach(function(b){b.concat(a)}),this._wBound=new bgl.cull.BoundBox(c),this},contains:function(a){return this.worldBound.overlap(a)},mvpMatrix:function(a){var b=this._vpMatirx;return b||(this._vpMatirx=b=this.viewMatrix.concat(this.perspectiveMatrix).paste()),a||(a=new b.constructor),a.paste().concat(this._vpMatirx)},concat:function(a){return this.freeze?this:(this._at.concat(a),this._front.concat(a),this._top.concat(a),this.reset())},orient:function(a,b){var c=this.at,d=this._front,e=d.elements,f=this.to;return a&&f.rotate(a,0,1,0),b&&f.rotate(b,1,0,0),f.normalize(),e[0]=f.x+c.x,e[1]=f.y+c.y,e[2]=f.z+c.z,this.reset()},get viewMatrix(){var a=this._vMatrix;if(!a){var b=this._front,c=this.up,d=this.at;this._vMatrix=a=bgl.math.Matrix4.setLookAt(d.x,d.y,d.z,b.x,b.y,b.z,c.x,c.y,c.z)}return a},get perspectiveMatrix(){if(!this._pMatrix){var a=bgl.math.Matrix4.setPerspective(this._fovy,this.aspect,this.near,this.far);return this._pMatrix=a,a}return this._pMatrix},get worldBound(){return this._wBound||this._constructBound(),this._wBound},get scene(){return this._scene}},bgl.model.Geometry.prototype={dispose:function(a){var b=function(b){b.dispose(a)},c=this._controller;this.binders.allOwnPros(b),c&&(c._scene&&c._scene.remove(c),c.dispose(a),c._scene=null,c._refer=null),this._culler.dispose(),this._parent=null},detect:function(a){return this.worldBound.overlap(a.worldBound)},set hittable(a){var b,c=this._hittable;a=!!a,c!=a&&(this._hittable=a,b=this.scene,b&&(a?b._detectors.add(this):b._detectors.remove(this)))},get hittable(){return this._hittable},get controller(){return this._controller},set controller(a){var b=this.controller;if(b!==a){var c=this.scene;b&&(c&&c.remove(b),b._refer=null),this._controller=a,a&&(a._waitUpdate&&c&&c.add(a),a._refer=this)}},get enable(){return this._enable!==!1},set enable(a){var b=this._enable;a!=b&&(this._enable=a,this.invalid())},get culler(){return this._culler},get culled(){var a=this._settings.alwaysCulled;return null===a?this._culler._culled:a},get worldBound(){return this._culler.worldBound},get worldMatrix(){return this._culler.worldMatrix},get modelMatrix(){return this._culler.modelMatrix},get modelBound(){return this._culler.modelBound},set modelBound(a){this._culler.modelBound=a,this.invalid()},get parent(){return this._parent},set parent(a){var b=this.parent;a instanceof bgl.model.Render&&b!==a&&(b&&b.remove(this),a.add(this))},invalid:function(){var a=this.parent;return a&&a.invalid(),this},concat:function(a){return this._culler.concat(a),this.invalid()},update:function(a){a.curGeometry=this},draw:function(a,b){this.indexBuffer.bind(a,b),a.drawElements(this.drawMode,this.indexBuffer.length,a.UNSIGNED_SHORT,0)},bind:function(a,b){for(var c=this.binders,d=Object.getOwnPropertyNames(c),e=0,f=d[0];f;f=d[++e])c[f].bind(a,b)},render:function(a,b){this.enable&&(this.update(b),null===this.culled&&this.culler.cull(b.camera),this.culled===!1&&(this.bind(a,b),this.draw(a,b)))},addBinder:bgl.model.Render.prototype.addBinder,removeBinder:bgl.model.Render.prototype.removeBinder,save:function(){return this._culler.save(),this},restore:function(a){return this._culler.restore(a),this},forget:function(){return this._culler.forget(),this},findBinder:function(a){return this.binders[a]}},bgl.cull={BoundBox:function(a,b,c,d,e,f){a instanceof Array?this._fromPoints(a):(this._center=new bgl.math.Vector3(a||0,b||0,c||0),this._hh=e||1,this._hw=d||1,this._hd=f||1,this._resetBounds())},CullNode:function(a,b){this._nodes=[],this._parent=null,this._refer=a,this._leaves=[],this._culled=null,this._mMatrix=b||new bgl.math.Matrix4},CullLeaf:function(a,b,c){this._parent=null,this._culled=null,this._refer=a,this._mMatrix=b||new bgl.math.Matrix4,this._mBound=c||new bgl.cull.BoundBox}},bgl.cull.BoundBox.prototype={constructor:bgl.cull.BoundBox,get points(){return this._points?this._points:this._constructPoints()},get radius(){var a=this._hw,b=this._hh,c=this._hd;return Math.sqrt(a*a+b*b+c*c)},get center(){return this._center},forget:function(){return delete this._states,this},equals:function(a){return a&&a._x1==this._x1&&a._x2==this._x2&&a._y1==this._y1&&a._y2==this._y2&&a._z1==this._z1&&a._z2==this._z2},inside:function(a){return a&&a._x1<=this._x1&&a._x2>=this._x2&&a._y1<=this._y1&&a._y2>=this._y2&&a._z1<=this._z1&&a._z2>=this._z2},_resetBounds:function(){var a=this.center,b=a.x,c=a.y,d=a.z,e=this._hh,f=this._hw,g=this._hd;return this._x1=b-f,this._x2=b+f,this._y1=c-e,this._y2=c+e,this._z1=d-g,this._z2=d+g,this},_constructPoints:function(){var a=bgl.math.Vector3,b=this._hd,c=this._hh,d=this._hw,e=this._center,f=e.x,g=e.y,h=e.z,i=[new a(f+d,g+c,h+b),new a(f-d,g+c,h+b),new a(f+d,g-c,h+b),new a(f+d,g+c,h-b),new a(f-d,g+c,h-b),new a(f-d,g-c,h+b),new a(f+d,g-c,h-b),new a(f-d,g-c,h-b)];return this._points=i,this._resetBounds(),i},_fromPoints:function(a){if(!a||0==a.length)return this.constructor.NULL;var b=a.min("x"),c=a.max("x"),d=a.min("y"),e=a.max("y"),f=a.min("z"),g=a.max("z"),h=bgl.math.Vector3;return this._hd=(g-f)/2,this._hh=(e-d)/2,this._hw=(c-b)/2,this._center=new h((b+c)/2,(d+e)/2,(f+g)/2),this._points=[new h(b,d,f),new h(c,d,f),new h(b,e,f),new h(b,d,g),new h(c,d,g),new h(c,e,f),new h(b,e,g),new h(c,e,g)],this._x1=b,this._x2=c,this._y1=d,this._y2=e,this._z1=f,this._z2=g,this},overlap:function(a){return a&&!(this._x2<a._x1||this._x1>a._x2)&&!(this._y2<a._y1||this._y1>a._y2)&&!(this._z2<a._z1||this._z1>a._z2)},union:function(a,b){var c;return c=a.points?a.points:a,c=c.concat(this.points),b!==!1?this._fromPoints(c):new this.constructor(c)},copy:function(a,b){return b=b||new this.constructor,a.allOwnPros(function(a,c){"object"!=typeof a?b[c]=a:a.paste&&(b[c]=a.paste())}),b},concat:function(a){var b=this.points;return b.forEach(function(b){b.concat(a)}),this._fromPoints(b)},save:function(){var a={_center:this._center.paste()},b=this._states||[];return this.allOwnPros(function(b,c){"object"!=typeof b&&(a[c]=b)}),b.push(a),this._states||(this._states=b),this},restore:function(a){var b,c,d,e=this._states;if(e){if(c=e.length,d=this,!c)return this;a>=c&&(a=c-1),e.length=c-(a||0),b=e.pop(),b.allOwnPros(function(a,b){d[b]=a}),this._points=null}return this},paste:function(){var a=this._center;return new this.constructor(a.x,a.y,a.z,this._hw,this._hh,this._hw)}},bgl.cull.CullLeaf.prototype={constructor:bgl.cull.CullLeaf,get geometry(){return this._refer},get modelBound(){return this._mBound},get worldBound(){var a=this._wBound;return a||(a=this.modelBound.paste().concat(this.worldMatrix),this._wBound=a),a},get modelMatrix(){return this._mMatrix},get worldMatrix(){var a=this._wMatrix;if(!this._wMatrix){var b=this.parent;a=b?this.parent.worldMatrix.paste().concat(this.modelMatrix):this.modelBound.paste(),this._wMatrix=a}return a},set modelBound(a){var b=this.modelBound;a instanceof bgl.cull.BoundBox&&!b.equals(a)&&(this._mBound=a,this._wBound=a.concat(this.worldMatrix),this._clearParentStates())},set modelMatrix(a){var b=this.modelMatrix;a instanceof bgl.math.Matrix4&&!b.equals(a)&&(this._mMatrix=a,this._wMatrix=this.worldMatrix,this._clearParentStates())},get parent(){return this._parent},cull:function(a){this._culled=!a.contains(this.worldBound)},_clearParentStates:function(){var a=this.parent;return a&&!this.worldBound.inside(a.worldBound)&&(a._wBound=a._culled=null,a._clearParentStates()),this},save:function(){return this.modelBound.save(),this.modelMatrix.save(),this},forget:function(){return this.modelBound.forget(),this.modelMatrix.forget(),this},restore:function(a){return this.modelBound.restore(a),this.modelMatrix.restore(a),this._clearSelfStates()},_clearSelfStates:function(){return this._culled=null,this._wMatrix=null,this._wBound=null,this},concat:function(a){return this.modelMatrix.concat(a),this._clearSelfStates()._clearParentStates()},dispose:function(){var a=this.parent,b=this._refer;a&&a.remove(this),b&&delete b._culler}},bgl.cull.CullNode.prototype={constructor:bgl.cull.CullNode,save:function(){return this.modelMatrix.save(),this},forget:function(){this.modelMatrix.forget()},restore:function(a){return this.modelMatrix.restore(a),this._clearSelfStates()._clearParentStates()},dispose:function(){var a=this.parent,b=this._refer;a&&a.remove(this),b&&delete b._culler},remove:function(a){var b=a._nodes?this._nodes.remove(a):this._leaves.remove(a);return b&&(b._parent=null,b._culled===!1&&(this._clearParentStates(),this._culled=null,this._mBound=null)),b},add:function(a){if(a.parent)return!1;var b=this.worldBound;if(a instanceof bgl.cull.CullLeaf&&this._leaves.add(a));else{if(!(a instanceof bgl.cull.CullNode&&this._nodes.add(a)))return!1;var c=this._leaves;a._leaves.forEach(function(a){c.add(a)}),a._clearLeavesStates()._clearChildrenStates()}return a._parent=this,a._clearSelfStates(),a.worldBound.inside(b)||(this._wBound=this.worldBound.union(a.worldBound,!0),this._culled=null,this._clearParentStates()),!0},_clearSelfStates:function(){return this._wBound=this._wMatrix=this._culled=null,this},_clearParentStates:function(){var a=this.parent;return a&&!this.worldBound.inside(a.worldBound)&&(a._wBound=a._culled=null,a._clearParentStates()),this},_clearLeavesStates:function(){for(var a=this._leaves,b=a[0],c=0;b;b=a[++c])b._clearSelfStates();return this},_clearChildrenStates:function(){for(var a=this._nodes,b=a[0],c=0;b;b=a[++c])b._clearSelfStates()._clearLeavesStates()._clearChildrenStates();return this},concat:function(a){return this.modelMatrix.concat(a),this._clearSelfStates()._clearParentStates()._clearLeavesStates()._clearChildrenStates()},cull:function(a,b){if(a.contains(this.worldBound)){var c,d,e;for(this._culled=!1,c=this._leaves,d=c[0],e=0;d;d=c[++e])d.cull(a);if(b)for(c=this._nodes,d=c[0],e=0;d;d=c[++e])d.cull(a,!0)}else this._culled=!0},get worldBound(){var a=this._wBound;if(!a){var b,c,d=this._leaves.concat(this._nodes),e=[];if(0==d.length)return bgl.cull.BoundBox.NULL;for(b=0,c=d[0];c;c=d[++b])e=e.concat(c.worldBound.points);a=new bgl.cull.BoundBox(e)}return a},get modelMatrix(){return this._mMatrix},get worldMatrix(){var a=this._wMatrix;if(!this._wMatrix){var b=this.parent;a=b?b.worldMatrix.paste().concat(this.modelMatrix):this.modelMatrix.paste(),this._wMatrix=a}return a},set modelMatrix(a){var b=this.modelMatrix;a instanceof bgl.math.Matrix4&&!b.equals(a)&&(this._mMatrix=a,this._clearParentStates(),this._clearChildrenStates())},get parent(){return this._parent}},bgl.cull.BoundBox.NULL=function(){var a=new bgl.cull.BoundBox;return a._points=[],a._x1=a._x2=a._y1=a._y2=a._z1=a._z2=0,a.inside=function(){return!0},a.union=function(a,b){return b!==!1?a.paste():a},a.concat=function(){return this},a.overlap=function(){return!0},a.save=function(){return this},a.restore=function(){return this._points=[],this._hh=this._hd=this._hw=0,this},a.forget=function(){},a.paste=function(){return this},a.restore(),a}(),bgl.resource={ResourceManager:function(a){var b=a.gl;this.gl=b,this._maxActiveTexureNum=b.getParameter(b.MAX_COMBINED_TEXTURE_IMAGE_UNITS)-1,this._maxCubeTextureNum=b.getParameter(b.MAX_CUBE_MAP_TEXTURE_SIZE),this._max2DTextureNum=b.getParameter(b.MAX_TEXTURE_SIZE),this._maxFrameBufferNum=b.getParameter(b.MAX_RENDERBUFFER_SIZE),this._maxRenderBufferNum=b.getParameter(b.MAX_RENDERBUFFER_SIZE),this._maxBufferNum=2048,this._texture2DS=[],this._textureCubes=[],this._buffers=[],this._renderBuffers=[],this._frameBuffers=[];for(var c=0,d=[],e=this._maxActiveTexureNum;e>c;c++)d[c]=0;this._indexUsage=d,this._bindingTexture=this._bindingBuffer=this._bindingFrameBuffer=null,this._activeIndex=void 0},Buffer:function(a,b,c){this._type=b||WebGLRenderingContext.ARRAY_BUFFER,a&&(this.data=a),this._bo=null,this.usage=c||WebGLRenderingContext.STATIC_DRAW,this._buffered=!1,this._refCount=0},Texture:function(a){this._to=null,this._index=-1,this._type=a?WebGLRenderingContext.TEXTURE_CUBE_MAP:WebGLRenderingContext.TEXTURE_2D,this._refCount=0},FrameBuffer:function(a,b,c){this._w=a||0,this._h=b||0,this._depthBuffer=c?new bgl.resource.RenderBuffer:null,this._texture=new bgl.resource.Texture(!1),this._index=null,this._fbo=null,this._buffered=!1,this.imgParam={TEXTURE_MAG_FILTER:"LINEAR",TEXTURE_MIN_FILTER:"LINEAR",TEXTURE_WRAP_S:"CLAMP_TO_EDGE",TEXTURE_WRAP_T:"CLAMP_TO_EDGE"},this._refCount=0},RenderBuffer:function(){this._rbo=null,this._refCount=0}},bgl.resource.RenderBuffer.prototype={get glObj(){return this._rbo},release:function(){var a=this._rbo;this._refCount=0,a&&(a.refer=null,this._rbo=null),this._buffered=!1},bind:function(a){var b=this.glObj;b||(this._rbo=b=a.cfg.resManager.getRenderBufferObj(this)),a.bindRenderbuffer(a.RENDERBUFFER,b),this._refCount++}},bgl.resource.FrameBuffer.prototype={get glObj(){return this._fbo},get depthBuffer(){return this._depthBuffer},get texture(){return this._texture},releaseDepthBuffer:function(){var a=this.depthBuffer;a&&a.release()},releaseTexture:function(){var a=this.texture;a&&a.releaseTexture(),this._texture=null},release:function(){this._fbo=null,this._refCount=0,this._buffered=!1},bind:function(a){this._refCount++,this.bufferData(a)||a.bindFramebuffer(a.FRAMEBUFFER,this._fbo),this._fbo._manager.bindingFrameBuffer=this},bufferData:function(a){if(!this._buffered){var b=a.cfg.resManager,c=this._fbo,d=this._texture,e=this._depthBuffer,f=this._w||a.canvas.width,g=this._h||a.canvas.height;if(c||(this._fbo=c=b.getFrameBufferObj(this)),d.bind(a),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,f,g,0,a.RGBA,a.UNSIGNED_BYTE,null),this.imgParam.allOwnPros(function(b,c){a.texParameteri(a.TEXTURE_2D,a[c],a[b])}),a.bindFramebuffer(a.FRAMEBUFFER,c),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d.glObj,0),e&&(e.bind(a),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,f,g),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,e.glObj)),a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE)throw Error("framebuffer fail");return this._buffered=!0,!0}return!1},set width(a){a=parseInt(a),a&&this._w!=a&&(this._w=a,this._buffered=!1)},set height(a){a=parseInt(a),a&&this._h!=a&&(this._h=a,this._buffered=!1)}},bgl.resource.Buffer.prototype={get glObj(){return this._bo},dispose:function(){},release:function(){var a=this._bo;this._refCount=0,a&&(a.refer=null,this._bo=null),this._buffered=!1},get buffered(){return this._buffered},get data(){return this._data},set data(a){a&&a!==this._data&&a.length&&(this._data=WebGLRenderingContext.ARRAY_BUFFER===this._type?a instanceof Float32Array?a:new Float32Array(a):a instanceof Int16Array?a:new Int16Array(a),this._buffered=!1,this.length=a.length)},bufferData:function(a){if(!this._buffered){var b=this._bo,c=a.cfg.resManager;return b||(this._bo=c.getBufferObj(this)),c.bindingBuffer=this,a.bufferData(this._type,this._data,this.usage),this._buffered=!0,!0}return!1},bind:function(a){this.bufferData(a)||(a.cfg.resManager.bindingBuffer=this),this._refCount++}},bgl.resource.Texture.prototype={get glObj(){return this._to},get refCount(){return this._refCount},set refCount(a){var b=this._refCount,c=a-b;this._refCount=a,this.glObj._manager._indexUsage[this._index]+=c},release:function(){var a=this.glObj,b=a._manager;this.refCount=0,a._refer=null,this._buffered=!1,b.calculateIndexUsage(),bgl.resource.Texture.apply(this,[this._type])},bind:function(a){var b=this._to,c=this._index,d=a.cfg.resManager;b||(this._to=d.getTextureObj(this)),-1==c&&(this._index=c=d.getMinUsedTexIndex(!1)),this._buffered=!0,d.activeIndex=c,d.bindingTexture=this,this.refCount++},dispose:function(){var a=this._manager,b=this._type==WebGLRenderingContext.TEXTURE_CUBE_MAP?a._textureCubes:a._texture2DS;this.release(),b.remove(this),a.gl.deleteTexture(this._texture),a.calculateIndexUsage()}},bgl.resource.ResourceManager.prototype={set bindingBuffer(a){var b=this._bindingBuffer;if(a instanceof bgl.resource.Buffer){var c=this.gl,d=a.glObj;if(b&&b.glObj===d)return;c.bindBuffer(a._type,d),this._bindingBuffer=a}},set bindingTexture(a){var b=this._bindingTexture;if(a instanceof bgl.resource.Texture){var c=this.gl,d=a.glObj;if(b&&b.glObj==d)return;c.bindTexture(a._type||WebGLRenderingContext.TEXTURE_2D,d),this._bindingTexture=a}},set bindingFrameBuffer(a){var b,c,d=this._bindingFrameBuffer;if(a instanceof bgl.resource.FrameBuffer){if(c=a.glObj,d&&d.glObj===c)return}else{if(null!=a)return;c=null}b=this.gl,b.bindFramebuffer(b.FRAMEBUFFER,c),this._bindingFrameBuffer=a},get activeIndex(){return this._activeIndex},set activeIndex(a){if(this.activeIndex!=a){var b=this.gl;b.activeTexture(WebGLRenderingContext["TEXTURE"+a]),this._activeIndex=a}},get texture2DCount(){return this._texture2DS.length},get textureCubeCount(){return this._textureCubes.length},thrill:function(){for(var a=0,b=this._texture2DS,c=b[0];c;c=b[++a])c._refCount--;for(a=0,b=this._textureCubes,c=b[0];c;c=b[++a])c._refCount--;for(a=0,b=this._frameBuffers,c=b[0];c;c=b[++a])c.refer&&c.refer._refCount--;this.calculateIndexUsage()},_getResource:function(a,b,c,d){if(!a.release)throw"refer should implement release";var e;return this.thrill(),c.length<b?(e=d.apply(this.gl),c.add(e),e._manager=this):(e=this.getMinUsedResource(c),e.refer&&e.refer.release()),e.refer=a,e},getRenderBufferObj:function(a){return this._getResource(a,this._maxRenderBufferNum,this._renderBuffers,this.gl.createRenderbuffer)},getFrameBufferObj:function(a){return this._getResource(a,this._maxFrameBufferNum,this._frameBuffers,this.gl.createFramebuffer)},getBufferObj:function(a){return this._getResource(a,this._maxBufferNum,this._buffers,this.gl.createBuffer)},getTextureObj:function(a,b){if(!a.release)throw Error("refer should release");return b?this._getResource(a,this._maxCubeTextureNum,this._textureCubes,this.gl.createTexture):this._getResource(a,this._max2DTextureNum,this._texture2DS,this.gl.createTexture)},getMinUsedResource:function(a){for(var b=0,c=a,d=c[0],e=d;d;d=c=[++b]){if(!d.refer)return d;d.refer._refCount<e.refer._refCount&&(e=d)}return e},getMinUsedTexIndex:function(a){a&&this.calculateIndexUsage();var b=this._indexUsage,c=b[0];return b.forEach(function(a){c>a&&(c=a)}),this._indexUsage.indexOf(c)},calculateIndexUsage:function(){for(var a=this._indexUsage,b=function(b){a[b._index]+=b._refCount
},c=0,d=a.length;d>c;c++)a[c]=0;this._texture2DS.forEach(b),this._textureCubes.forEach(b)}},bgl.data={cubic:{vertexArray:new Float32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1]),vertexIndecies:new Uint16Array([0,1,2,0,2,3,0,3,4,0,4,5,0,5,6,0,6,1,1,6,7,1,7,2,7,4,3,7,3,2,4,7,6,4,6,5]),vertexUV:new Float32Array([1,1,1,1/3,.5,-1,1,1,0,.5,-1,-1,1,0,1,1,-1,1,1/3,1,1,1,-1,1/3,0,-1,1,-1,2/3,0,-1,-1,-1,2/3,.5,1,-1,-1,1/3,.5,-1,1,1,2/3,.5,-1,1,-1,1/3,.5,-1,-1,-1,1/3,1,-1,-1,1,2/3,1,1,1,1,2/3,.5,1,-1,1,2/3,1,1,-1,-1,1,1,1,1,-1,1,.5,1,1,1,0,0,1,1,-1,0,.5,-1,1,-1,1/3,.5,-1,1,1,1/3,0,1,-1,1,2/3,.5,1,-1,-1,2/3,0,-1,-1,-1,1,0,-1,-1,1,1,.5]),uv:new Float32Array([1/3,.5,0,.5,0,1,1/3,1,1/3,0,2/3,0,2/3,.5,1/3,.5,2/3,.5,1/3,.5,1/3,1,2/3,1,2/3,.5,2/3,1,1,1,1,.5,0,0,0,.5,1/3,.5,1/3,0,2/3,.5,2/3,0,1,0,1,.5]),uvIndex:new Uint16Array([0,1,2,0,2,3,4,6,5,4,7,6,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,22,21,20,23,22])},matrix:{RGB2XYZ:new bgl.math.Matrix3([.4124,.2126729,.0193339,.3575761,.7152,.119192,.1804375,.072175,.9503041]),XYZ2RGB:new bgl.math.Matrix3([3.241,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252])},arrow:{vertex:[-.0265,-.2473,1,.7838,-.2474,.1405,.7838,.2474,.1405,-.0265,.2474,1,.2108,-.2474,.3137,.2108,.2474,.3137,.2108,-.2474,-1,.2108,.2473,-1,-.2382,-.2474,-1,-.2382,.2473,-1,-.2382,-.2474,.3137,-.2382,.2474,.3137,-.7838,-.2474,.1405,-.7838,.2474,.1405],indices:[0,1,2,0,2,3,1,4,5,1,5,2,4,6,7,4,7,5,6,8,9,6,9,7,8,10,11,8,11,9,10,12,13,10,13,11,12,0,3,12,3,13,0,4,1,10,0,12,10,4,0,6,10,8,4,10,6,3,2,5,11,13,3,11,3,5,7,9,11,5,7,11]}},function(){function a(a){if(a=a||3e3,a=3*Math.round(parseInt(a)/100-20),0>a||a>b.length)throw"invalid value";return a}var b=[.5926,.3334,.074,.5678,.3319,.1004,.5485,.3318,.1197,.5323,.3322,.1355,.5181,.3327,.1492,.5055,.3333,.1613,.4941,.3338,.1721,.4838,.3342,.1821,.4743,.3345,.1912,.4655,.3348,.1997,.4574,.335,.2076,.4499,.3351,.215,.4428,.3352,.2219,.4362,.3353,.2285,.43,.3353,.2347,.4242,.3352,.2405,.4188,.3352,.2461,.4136,.3351,.2513,.4087,.3349,.2563,.4041,.3348,.2611,.3997,.3346,.2657,.3955,.3344,.27,.3916,.3342,.2742,.3878,.334,.2782,.3842,.3338,.282,.3808,.3336,.2857,.3775,.3333,.2892,.3743,.3331,.2926,.3713,.3328,.2959,.3684,.3326,.299,.3657,.3323,.302,.363,.332,.3049,.3605,.3318,.3077,.358,.3315,.3105,.3557,.3313,.3131,.3534,.331,.3156,.3512,.3307,.3181,.3491,.3305,.3204,.3471,.3302,.3227,.3451,.3299,.325,.3432,.3297,.3271,.3414,.3294,.3292,.3396,.3292,.3312,.3379,.3289,.3332,.3362,.3287,.3351,.3346,.3284,.337,.3331,.3282,.3388,.3315,.3279,.3405,.3301,.3277,.3423,.3287,.3274,.3439,.3273,.3272,.3455,.3259,.327,.3471,.3246,.3267,.3486,.3234,.3265,.3501,.3221,.3263,.3516,.3209,.326,.353,.3198,.3258,.3544,.3186,.3256,.3558,.3175,.3254,.3571,.3165,.3252,.3584,.3154,.3249,.3596,.3144,.3247,.3609,.3134,.3245,.3621,.3124,.3243,.3632,.3115,.3241,.3644,.3106,.3239,.3655,.3097,.3237,.3666,.3088,.3235,.3677,.3079,.3233,.3687,.3071,.3232,.3698,.3063,.323,.3708,.3055,.3228,.3717,.3047,.3226,.3727,.3039,.3224,.3737,.3032,.3222,.3746,.3024,.3221,.3755,.3017,.3219,.3764,.301,.3217,.3773,.3003,.3216,.3781,.2997,.3214,.3789,.299,.3212,.3798];bgl.data.getRGBRatio=function(c,d){var e,f,g=0,h=0,i=0;return 1/6>c?(g=1,h=6*c):1/3>c?(g=2-6*c,h=1):.5>c?(h=1,i=6*c-2):2/3>c?(h=4-6*c,i=1):5/6>c?(h=6*c-4,i=1):(g=1,i=6-6*c),e=g+h+i,0==e?new bgl.math.Vector3:(f=a(d),new bgl.math.Vector3(g/(e*b[f]),h/(e*b[f+1]),i/(e*b[f+2])))},bgl.data.getTemRatio=function(c,d){for(var e=a(c),f=a(d),g=new bgl.math.Vector3,h=g.elements,i=0;3>i;i++)h[i]=b[e+i]/b[f+i];return g}}(),function(){var a=function(a,b){var c={enumerable:!1,configurable:!0,get:new Function("return this._"+a+";"),set:new Function("val","if (isNaN(val) || val == this._{0}) return;this._{0} = val;this.reset();".format(a))};Object.defineProperty(b,a,c)},b=bgl.model.Camera.prototype;["near","far","aspect"].forEach(function(c){a(c,b)})}(),function(){var fbody,box=bgl.cull.BoundBox.prototype,leaf=bgl.cull.CullLeaf.prototype,node=bgl.cull.CullNode.prototype,fun,name,render=bgl.model.Render.prototype,geo=bgl.model.Geometry.prototype,camera=bgl.model.Camera.prototype;[{name:"Translate",params:"'x','y','z'"},{name:"Scale",params:"'x','y','z'"},{name:"Rotate",params:"'a','x','y','z'"}].forEach(function(p){fbody="return this.concat(bgl.math.Matrix4.set{0}({1}));".format(p.name,p.params.replace(/'/g,"")),fun=eval("new Function({0},'{1}')".format(p.params,fbody)),name=p.name.toLowerCase(),box[name]=fun,node[name]=fun,leaf[name]=fun,render[name]=fun,geo[name]=fun,camera[name]=fun}),["model","foundation","math"].forEach(function(a){var b,c,d=bgl[a],e=Object.getOwnPropertyNames(d);for(c=0,b=e[0];b;b=e[++c])bgl[b]=d[b]})}(),bgl&&(bgl.pls=function(a,b){function c(a,b){switch(a.length){case 1:m.manualPlay();var c=a[0];c.dy=-c.dy,f.apply(this,[c,b]);break;case 2:this.shouldClear=!0;var d=a[0],e=a[1],g=d.dx,h=e.dx,i=d.dy,j=e.dy;if(0>g&&0>h)return b.curCamera.move("right");if(h>0&&g>0)return b.curCamera.move("left");if(0>i&&0>j)return b.curCamera.move("down");if(j>0&&i>0)return b.curCamera.move("up");if(d.event==e.event&&"drag"==d.eventType){var k=d.clientX<e.clientX?d:e,l=k==d?e:d,n=d.clientY>e.clientY?d:e,o=n==d?e:d;k.dx>0&&l.dx<0&&n.dy<0&&o.dy>0?m.adjustCanvas(b.gl.canvas,!1):k.dx<0&&l.dx>0&&n.dy>0&&o.dy<0&&m.adjustCanvas(b.gl.canvas,!0)}}}function d(a,b){return Math.abs(b.x)<.5&&Math.abs(b.z)<.5}function e(a,b){m.manualPlay(),b.curCamera.move(a.defination)}function f(a,b){var c,d=this.pEvents.mouse;d&&(c=d[d.length-1]),!c||"click"!=c.eventType&&"press"!=c.eventType||(this.shouldClear=!1,m.manualPlay(),c=d[d.length-2],c&&"click"==c.eventType&&(m.adjustCanvas(b.gl.canvas,!m.expanded),this.shouldClear=!0)),"drag"==a.eventType?g(b.curCamera,-a.dx,-a.dy):"release"==a.eventType&&a.accumulatedX/(a.timeStamp-a.startTime)>2&&m.autoPlay()}function g(a,b,c){Math.abs(b)<2?b=0:-5>b?b=-5:b>5&&(b=5),a.orient(.3*b,.5*c)}function h(a){a.width=m.normalLocation.w,a.height=m.normalLocation.h;var b=bgl.init(a),c=new bgl.model.Scene,d=c.rootRender,e=b.cfg;k=e,b.enable(b.DEPTH_TEST),b.enable(b.BLEND),m.maxTextureSize=b.getParameter(b.MAX_TEXTURE_SIZE),e.add(c),o.rootRender(d),d.add(o.roomRender(b)),d.add(o.roomBlender(b)),o.eventPool(e.eventPool),o.camera(c.camera),m.camera=c.camera,m.adjustCanvas(a,!1),Object.defineProperty(m,"onupdate",{set:function(a){e.on("update",a)}}),e.run()}var i,j,k,l,m={normalLocation:b.normalLocation||{x:512,y:100,w:512,h:512},expandLocation:{x:0,y:0,w:document.documentElement.clientWidth,h:document.documentElement.clientHeight},adjustCanvas:function(b,c){var d,e=(b||a).style;c?(d=m.expandLocation,e.zIndex=100,e.position="absolute",e.marginTop=0):(d=m.normalLocation,e.zIndex=-1,e.position="relative",e.marginTop=-d.y+"px"),e.left=d.x+"px",e.top=d.y+"px",l.width=k.width=d.w,l.height=k.height=d.h,m.expanded=!!c},maxTextureSize:4096};Object.defineProperty(m,"visible",{get:function(){return"none"!=a.style.display},set:function(b){k.scenes[0].invalid(),a.style.display=b?"block":"none"}}),m.debug=function(){var a,b=i._geometries,c=j.findBinder("uCalParam").value.elements;console.log("uSumIntensity:{0}".format(j.findBinder("uSumIntensity").value)),console.log("A:{0},B{1}".format(c[0],c[1])),b.forEach(function(b,c){b.enable&&(a=b.binders.uTemRatio._val.elements,console.log("geo {0}:intensity {1},tem x:{2} y:{3} z{4}".format(c,b.binders.uIntensity.value,a[0],a[1],a[2])))})},m.changeSumIntensity=function(a){return a=parseInt(a),!a||0>=a?console.warn("sumIntensity must larger than 0"):(j.findBinder("uSumIntensity").value=a,i.findBinder("uSumIntensity").value=a,a)},m.restoreCamera=function(){{var a=i.scene.camera;a._at}a.restore(),a.save(),m.adjustCanvas(null,m.expanded)},m.reset=function(a){for(var b=i._geometries,c=i.scene.camera,d=(c._at,0),e=b[0];e;e=b[++d])e.binders.uIntensity.value=0,d>=a&&(e.enable=!1);j.findBinder("uSumIntensity").value=a,i.findBinder("uSumIntensity").value=a},m.turnOff=function(){i._geometries.forEach(function(a){a.enable=!1})},m.changeIntensity=function(a,b){var c=i._geometries[a].binders.uIntensity,d=c._val;return d==b?d:(i._geometries[a].enable=0!=b,c.value=b)},m.changeImg=function(a,b){var c=i._geometries[a];if(!b)return c.findBinder("sEnv0").img=b,m.changeIntensity(a,0);if(!(b instanceof Image&&b.src&&b.complete))throw"img not loaded";return c.findBinder("sEnv0").img=b,c.enable=!0,c},m.changeABK=function(a,b,c){c=c||1;var d=j.findBinder("uCalParam").value.elements;d[0]=a*c,d[1]=b,d[2]=c},m.changeTem=function(a,b,c){return i._geometries[a].findBinder("uTemRatio").value=0>=b?bgl.data.getRGBRatio(-b):bgl.data.getTemRatio(b,c)},Object.defineProperty(m,"onmove",{set:function(a){m.on("move",a)}});var n=b.shaders||{roomVS:"precision mediump float;attribute vec3 aVertex;attribute vec2 aTexCoord;uniform mat4 uMVPMatrix;varying vec2 vTexCoord;void main(){gl_Position=vec4(aVertex,1.0)*uMVPMatrix;vTexCoord=aTexCoord;}",roomFS:"precision highp float;varying vec2 vTexCoord;uniform sampler2D sEnv0;uniform float uIntensity;uniform float uSumIntensity;uniform mat3 uRGBtoXYZ;uniform mat3 uXYZtoRGB;uniform vec3 uTemRatio;float YRatio(vec3 c0,vec3 xyz){  return (c0*uRGBtoXYZ).y/xyz.y;}vec3 RGBtoXYZ(vec3 rgb){    vec3 xyz=rgb*uTemRatio*uRGBtoXYZ;	return xyz*YRatio(rgb,xyz)*uIntensity;}void main(){vec3 c=RGBtoXYZ(texture2D(sEnv0,vTexCoord).rgb);gl_FragColor=vec4(c*uXYZtoRGB,1.0/uSumIntensity);}",blendVS:"precision mediump float;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main(){gl_Position=vec4(aTexCoord,0.0,1.0);vTexCoord=vec2(aTexCoord.x*0.5+0.5,aTexCoord.y*0.5+0.5);}",blendFS:"precision highp float;uniform vec4 uCalParam;uniform mat3 uRGBtoXYZ;uniform mat3 uXYZtoRGB;varying vec2 vTexCoord;uniform sampler2D sBuffer;uniform float uSumIntensity;vec3 Reinhard(vec3 xyz,float A, float B){    vec3 res=vec3(0.0);    res.y=xyz.y* A;	res.y=res.y *(1.0+ res.y/B)/(1.0+res.y);	float r=res.y/xyz.y;	res.x=xyz.x*r;	res.z=xyz.z*r;	return res;}vec3 XYZtoRGB(vec3 xyz){ return xyz*uXYZtoRGB;}void main(){ vec3 sumXYZ=texture2D(sBuffer,vTexCoord).rgb*uSumIntensity*uRGBtoXYZ; vec3 res=Reinhard(sumXYZ,uCalParam[0],uCalParam[1]); res=XYZtoRGB(res); gl_FragColor=vec4(res,1.0);}"},o={rootRender:function(a){a.addBinder(function(a,b){b.glClear(!0)},"clean"),a.controller=function(){var a=new bgl.animation.SimpleClock(40,1,1,0,null,!0);return a.ontick=function(b,c){c.scene.camera.rotate(360*Math.sin(a.value-b),0,1,0)},m.autoPlay=function(b){a._stopped&&(a.duration=b||40,a.restart())},m.manualPlay=function(){a.end()},a}()},roomRender:function(a){var c=new bgl.model.Render,d=new bgl.resource.Buffer(bgl.data.cubic.vertexUV),e=5*Float32Array.BYTES_PER_ELEMENT,f=3*Float32Array.BYTES_PER_ELEMENT,g=new bgl.resource.FrameBuffer(m.normalLocation.width,m.normalLocation.height);l=g,c.program=bgl.createProgram(a,n.roomVS,n.roomFS),c.frameBuffer=g,c.addBinder(new bgl.foundation.Attribute("aVertex",d,e,0)).addBinder(new bgl.foundation.Attribute("aTexCoord",d,e,f)).addBinder(new bgl.foundation.Uniform("uSumIntensity",0)).addBinder(new bgl.foundation.Uniform("uRGBtoXYZ",bgl.data.matrix.RGB2XYZ)).addBinder(new bgl.foundation.Uniform("uXYZtoRGB",bgl.data.matrix.XYZ2RGB)).addBinder(new bgl.foundation.Uniform("uMVPMatrix",c.modelMatrix,function(a,b){return b.curCamera.mvpMatrix(a)},!0)).addBinder(function(a,b){a.blendFunc(a.SRC_ALPHA,a.ONE),b.curFrameBuffer=g,b.glClear()},"masker");for(var h,j,k=[],o=0,p=b.maxLG||12;p>o;o++)h=new bgl.model.Geometry(bgl.data.cubic.uvIndex),j=new bgl.foundation.Sampler2D("sEnv0"),h.addBinder(new bgl.foundation.Uniform("uIntensity",0)).addBinder(new bgl.foundation.Uniform("uTemRatio",bgl.data.getTemRatio(3e3))),h.enable=!1,c.add(h),k[o]=h.addBinder(j);return i=c,c},roomBlender:function(a){var b=new bgl.model.Render;return b.program=bgl.createProgram(a,n.blendVS,n.blendFS),b.addBinder(new bgl.foundation.Attribute("aTexCoord",[-1,1,1,1,1,-1,-1,-1])).addBinder(new bgl.foundation.Uniform("uSumIntensity",0)).addBinder(new bgl.foundation.Uniform("uRGBtoXYZ",bgl.data.matrix.RGB2XYZ)).addBinder(new bgl.foundation.Uniform("uXYZtoRGB",bgl.data.matrix.XYZ2RGB)).addBinder(new bgl.foundation.Uniform("uCalParam",new bgl.math.Vector4)).addBinder(function(a,b){var c=b.curProgram.uniforms.sBuffer._loc,d=b.curFrameBuffer.texture;b.curFrameBuffer=null,d.bind(a),a.uniform1i(c,d._index),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)},"buffer"),b.add(new bgl.model.Geometry([0,1,2,0,2,3])),Object.defineProperty(m,"blender",{get:function(){return b}}),j=b,m.blender=b,b},entryRender:function(){new bgl.model.Render},eventPool:function(a){a.addKeyDefinition("up",38,87).addKeyDefinition("down",83,40).addKeyDefinition("left",37,65).addKeyDefinition("right",39,68),a.onupdate=function(b,d){var g=[];b.forEach(function(a){"key"==a.identifier?e.apply(this,[a,d]):"mouse"==a.identifier?f.apply(this,[a,d]):g.push(a)},a),g.length&&c.apply(this,[g,d])}},camera:function(a){a.far=5,a.fovy=30,a.move=function(b){var c,e=this.to,f=.02;switch(b){case"down":f*=-1;break;case"right":e=this.right;break;case"left":e=this.right,f*=-1}c=this.at.paste().plus(e.x*f,0,e.z*f),d(this,c)&&(a.translate(e.x*f,0,e.z*f),m.emit("move",[a]))},a.rotate(180,0,1,0),a.translate(0,0,.3),a.save()}},p=a.style;return p["float"]="left",h(a),o=null,n=null,m});