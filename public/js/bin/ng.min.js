window.app={ngModule:angular.module("br",[]),cfg:function(){var a=document.querySelector("#cfg"),b=a.innerHTML;return a.innerHTML=""||JSON.parse(b)}()},function(a){function b(a,b){for(var c=0,d=a[0];d;d=a[++c])if(d.name===b)return d}a.controller("bannerController",["$scope","$timeout","imgFactory","cfgFactory","glFactory",function(a,c,d,e,f){function g(b){var c=b?"beginLoading":"endLoading";a.$broadcast(c),a.waiting=b}a.waiting=a.waitingScene=0,a.scenes=e.scenes,a.states=e.states,a.covering=1,a.chooseScene=function(c){a.modes=c.modes,a.curScene=c,a.chooseState(b(a.states,c.defState)),a.chooseMode(b(c.modes,c.defMode)),a.waitingScene=1,f.restoreCamera()},a.chooseMode=function(c){if(a.curScene){var h=b(a.curScene.modes,c.name);f.setABK.apply(null,h.ABK),g(!0),a.$broadcast("dropTitleChange",{selected:c.name,role:"mode",modeDef:e.modes[c.name]}),a.lgNames=h.lgNames,d.$get(h.res).then(function(b){f.imgs=b,g(!1),a.covering=0,a.waitingScene=0},function(a){alert("加载图片失败"),console.log(a)})}},a.chooseState=function(b){f.setWeights(b.weights),f.lum=b.defLum/100,f.tem=b.defTem,a.$broadcast("stateChange",b),a.$broadcast("dropTitleChange",{selected:b.name,role:"state"})},a.$on("selectedChange",function(b,c){var d=c.to;switch(c.scope.role){case"scene":return a.chooseScene(d);case"mode":return c.scope.iconSrc=d.iconSrc,a.chooseMode(d);case"state":return a.chooseState(d)}}),c(function(){})}]).controller("dropController",["$scope",function(a){a.toggle=function(){a.showMenu=!a.showMenu},a.showMenu=!1,a.selectItem=function(b){var c=a.items[b],d=a.selectedItem;d!==c&&(a.selected=c.name,a.$emit("selectedChange",{from:d,to:a.selectedItem=c,scope:a})),a.showMenu=!1},a.$on("dropTitleChange",function(b,c){var d=a.role;c.role==a.role&&(a.selected=c.selected,"mode"==d&&c.modeDef&&(a.iconSrc=c.modeDef.iconSrc))})}]).controller("rangeController",["$scope","glFactory",function(a,b){a.mutable=!1,a.onchange=function(c){var d=a.role;"lum"==d&&(c/=100),b[a.role]=c},a.$on("stateChange",function(b,c){var d=a.role;if(a.mutable=c.mutable,"tem"==d){var e=c.tem;a.min=e.min,a.max=e.max,a.step=e.step,a.value=c.defTem}else"lum"==d?a.value=c.defLum:"w0"==d?a.value=100*c.weights[0]:"w1"==d&&(a.value=100*c.weights[1])})}]).controller("multiController",["$scope","glFactory",function(a,b){a.mutable=!1,a.values=[],a.oriTitle=a.title,a.toggle=function(b){b?(a.onselect(void 0),a.onchange(a.value)):a.showMenu=!a.showMenu},a.getItemValue=function(a){return this.values[this.items.indexOf(a)]},a.onselect=function(b){a.values[a.selectedIndex]=a.value,a.selectedIndex=b,a.title=a.items[b],a.value=a.values[b]||0},a.onchange=function(c){var d=a.role,e=a.selectedIndex;c=parseInt(c),void 0===e?(a.value=(a.values=a.items.map(function(){return c}))[0],a.title=a.oriTitle):a.values[e]=c,"weight"==d?b.setWight(e,c/100):"tem"==d&&b.setTem(e,c)},a.$on("stateChange",function(b,c){var d,e=a.role;if(a.mutable=c.mutable,"tem"==e){var f=c.tem;a.min=f.min,a.max=f.max,a.step=f.step,d=a.value=c.defTem,a.values=c.weights.map(function(){return d})}else"weight"==e&&(a.min=0,a.max=100,a.step=1,a.value=(a.values=c.weights.map(function(a){return 100*a}))[0])})}])}(window.app.ngModule),function(a){a.directive("drop",function(){return{restrict:"EA",replace:!0,scope:{iconSrc:"@iconSrc",items:"=items",selected:"@title",role:"@role"},controller:"dropController",template:"<div class='drop' ng-click='toggle();'><div class='dropHeader'><img ng-src='{{iconSrc}}'><p>{{selected}}</p></div><div ng-mouseleave='toggle()' class='menu' ng-show='showMenu&&items&&items.length'><p ng-repeat='item in items' data-item ng-click='selectItem($index);'>{{item.name}}</p></div></div>"}}).directive("iconRange",function(){return{restrict:"EA",replace:!0,scope:{iconSrc:"@iconSrc",title:"@title",unit:"@unit",value:"@value",role:"@role",min:"@min",max:"@max",step:"@step"},controller:"rangeController",template:"<div class='icon-range'><img ng-src='{{iconSrc}}'><p>{{title}}{{value}}{{unit}}</p><input type='range' ng-model='value' ng-disabled='!mutable'  ng-change='onchange(value)' min='{{min}}' max='{{max}}' step='{{step}}' ng-class=\"{true:'active',false:'inactive'}[mutable]\"></div>"}}).directive("multiRange",function(){return{restrict:"EA",replace:!0,scope:{iconSrc:"@iconSrc",title:"@title",unit:"@unit",value:"@value",role:"@role",min:"@min",max:"@max",step:"@step",items:"=items"},controller:"multiController",template:"<div class='multi-range'><div class='icon-range dropHeader drop'><img ng-src='{{iconSrc}}' ng-click='toggle(true)'><p ng-click='toggle()'>{{title}}</p><input type='range' ng-model='value' ng-disabled='!mutable'  ng-change='onchange(value)' min='{{min}}' max='{{max}}' step='{{step}}' ng-class=\"{true:'active',false:'inactive'}[mutable]\"><p>{{value}}{{unit}}</p></div><div ng-mouseleave='toggle()' class='menu' ng-show='showMenu&&items&&items.length'><p ng-repeat='item in items' data-item ng-click='onselect($index);'>{{item}}:{{getItemValue(item)}}{{unit}}</p></div></div>"}})}(window.app.ngModule),function(a){a.factory("imgFactory",["$q","glFactory","$http",function(a,b,c){function d(a){var b,c,d,e=a.naturalHeight,f=a.naturalWidth;if(!(e>j||f>j))return console.log("imgSize:"+f+"/"+e),a;e>f?(c=j,b=parseInt(j/e*f)):(b=j,c=parseInt(j/f*e)),d=i.canvas,d.height=c,d.width=b,i.clearRect(0,0,b,c),i.drawImage(a,0,0,f,f,0,0,b,c);var g=new Image;return g.src=d.toDataURL("image/png"),console.log("change img size:"+g.naturalWidth+"/"+g.naturalHeight),g}function e(b){var c=a.defer(),e=new Image;return e.onload=function(){g[b]=d(e),c.resolve(e)},e.onerror=function(a){g[b]=new Error(a),c.reject(a)},e.src=h+b,console.log("begin load img:"+b),c.promise}function f(b){var c=g[b];return c?c instanceof Image?a(function(a){a(c)}):c instanceof Error?a.reject(c):c:g[b]=e(b)}var g={},h="resources\\",i=document.createElement("canvas").getContext("2d"),j=b.MAX_TEXTURE_SIZE;return console.postInfo&&(console.postInfo=function(a,b){c.get("/debug/"+a+":"+b)}),{$get:function(b){return"string"==typeof b?f(b):b.map?a.all(b.map(function(a){return f(a)})):void 0},setImgSize:function(a){isNaN(a)||(j=parseInt(j,10))}}}]).factory("cfgFactory",function(){return window.app.cfg}).factory("glFactory",function(){function a(){c.dirty=!0}var b,c,d,e=document.domEle=document.documentElement,f=document.querySelector("body>menu"),g=document.querySelector("#glcvs");return b=bgl.pls(g,{maxLG:6,normalLocation:{x:0,get y(){return f.clientHeight},get w(){return e.clientWidth},get h(){return e.clientHeight-f.clientHeight}}}),d=g.getContext("webgl"),g.addEventListener("webglcontextlost",function(a){console.warn("gl lost context"),a.preventDefault()}),c={weights:[],imgs:[],baseTem:window.app.cfg.baseTem||3e3,tems:[]},console.log(c.textureSize=d.getParameter(d.MAX_TEXTURE_SIZE)),b.onupdate=function(){if(c.dirty){var a=c.weights,d=c.imgs,e=Math.min(d.length,a.length),f=c.lum,g=c.tems,h=c.baseTem;b.reset(e);for(var i=0;e>i;i++)b.changeImg(i,d[i]),b.changeIntensity(i,f*a[i]),b.changeTem(i,g[i],h);c.dirty=!1}},b.reset(0),b.adjustCanvas(g,!1),document.addEventListener("resize",function(){b.adjustCanvas(g,b.expanded)}),window.app.glDebug=b.debug,window.app.camera=b.camera,{get tem(){return c.tem},set baseTem(b){isNaN(b)||c.baseTem==b||a(c.baseTem=b)},get baseTem(){return c.baseTem},get MAX_TEXTURE_SIZE(){return c.textureSize},set tem(b){isNaN(b=parseInt(b))||a(c.tems=c.imgs.map(function(){return b}))},get lum(){return c.lum},set lum(b){c.lum==b||isNaN(b)||a(c.lum=b)},set imgs(b){if(b.every(function(a){return a instanceof Image&&a.complete}))return a(c.imgs=b.slice());throw Error("invalid imgs")},setABK:function(a,c,d){return b.changeABK(a,c,d)},set w0(b){c.weights[0]=parseFloat(b)/100||0,c.lum=1,a()},set w1(b){c.weights[1]=parseFloat(b)/100||0,c.lum=1,a()},restoreCamera:b.restoreCamera,getWeight:function(a){return 100*c.weights[a]},setTem:function(b,d){return void 0==b?this.tem=d:void(isNaN(d=parseInt(d))||a(c.tems[b]=d))},setWight:function(b,d){isNaN(d)||(void 0==b&&(c.weights=c.imgs.map(function(){return d})),a(c.weights[b]=d))},setWeights:function(b){return a(c.weights=b.slice())},set visible(a){b.visible=a}}})}(window.app.ngModule);